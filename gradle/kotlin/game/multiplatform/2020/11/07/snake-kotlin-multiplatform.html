<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin) | Londogard</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin)" />
<meta name="author" content="Hampus Londögård" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform." />
<meta property="og:description" content="A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform." />
<link rel="canonical" href="https://blog.londogard.com/gradle/kotlin/game/multiplatform/2020/11/07/snake-kotlin-multiplatform.html" />
<meta property="og:url" content="https://blog.londogard.com/gradle/kotlin/game/multiplatform/2020/11/07/snake-kotlin-multiplatform.html" />
<meta property="og:site_name" content="Londogard" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-07T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://blog.londogard.com/gradle/kotlin/game/multiplatform/2020/11/07/snake-kotlin-multiplatform.html","@type":"BlogPosting","headline":"How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin)","dateModified":"2020-11-07T00:00:00-06:00","datePublished":"2020-11-07T00:00:00-06:00","author":{"@type":"Person","name":"Hampus Londögård"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.londogard.com/gradle/kotlin/game/multiplatform/2020/11/07/snake-kotlin-multiplatform.html"},"description":"A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.londogard.com/feed.xml" title="Londogard" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header" role="banner">

    <div class="wrapper">
<a class="site-title" rel="author" href="/">Londogard</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
<a class="page-link" href="/about">About↗</a><a class="page-link" href="/londogard">Londogard↗</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a>
</div>
        </nav>
</div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin)</h1>
<p class="page-description">A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform.</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-11-07T00:00:00-06:00" itemprop="datePublished">
        Nov 7, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Hampus Londögård</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      26 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i> 
      
        <a class="category-tags-link" href="/categories/#gradle">gradle</a>
         
      
        <a class="category-tags-link" href="/categories/#kotlin">kotlin</a>
         
      
        <a class="category-tags-link" href="/categories/#game">game</a>
         
      
        <a class="category-tags-link" href="/categories/#multiplatform">multiplatform</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1">
<a href="#part-1-how-does-kotlin-multiplatform-work">Part 1: How does Kotlin Multiplatform work?</a>
<ul>
<li class="toc-entry toc-h2"><a href="#llvm">LLVM</a></li>
<li class="toc-entry toc-h2">
<a href="#how-the-kotlin-compiler-works-frontend-to-backend">How the Kotlin Compiler works, Frontend to Backend</a>
<ul>
<li class="toc-entry toc-h3"><a href="#the-kotlin-compiler-frontend">The Kotlin Compiler Frontend</a></li>
<li class="toc-entry toc-h3"><a href="#the-kotlin-compiler-backend">The Kotlin Compiler Backend</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#how-kotlin-keeps-multiplatform-clean">How Kotlin keeps multiplatform clean</a></li>
<li class="toc-entry toc-h2"><a href="#summarizing-how-multiplatform-works">Summarizing how Multiplatform works</a></li>
<li class="toc-entry toc-h2"><a href="#outro-kotlin-multiplatform-and-why-it-matters">Outro: Kotlin Multiplatform and why it matters</a></li>
</ul>
</li>
<li class="toc-entry toc-h1">
<a href="#part-2-how-to-set-up-multiplatform-and-build-snake">Part 2: How to set up Multiplatform and build Snake</a>
<ul>
<li class="toc-entry toc-h2">
<a href="#building-a-jvm-app-snake">Building a JVM App (Snake)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#drawing-the-snake--apple">Drawing the snake &amp; apple</a></li>
<li class="toc-entry toc-h3">
<a href="#creating-the-data-structures">Creating the data structures</a>
<ul>
<li class="toc-entry toc-h4"><a href="#adding-a-direction">Adding a Direction</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#wrapping-up-the-code-with-some-minor-refactoring--new-functionality">Wrapping up the code with some minor refactoring / new functionality</a></li>
</ul>
</li>
<li class="toc-entry toc-h1">
<a href="#part-3-true-multiplatform-moving-to-js--native">Part 3: True multiplatform (moving to JS &amp; Native)</a>
<ul>
<li class="toc-entry toc-h2"><a href="#jsbrowser-target">JS/Browser target</a></li>
<li class="toc-entry toc-h2"><a href="#native-target">Native target</a></li>
</ul>
</li>
</ul>
<p>A three part blog (all included in this one) that goes through</p>

<ol>
  <li>How Kotlin Multiplatform works (compiler and everything)</li>
  <li>How to build a game (Snake) and finally</li>
  <li>how to make it multiplatform.</li>
</ol>

<p><strong>All the code is available <a href="https://github.com/londogard/snake-js-jvm-native">here</a>.</strong></p>

<p>It’s highly recommended using IntelliJ, a free (community) edition can be downloaded from <a href="https://www.jetbrains.com/idea/download/#section=windows">jetbrains.com</a>.<br>
It’s also required that your Kotlin version is above 1.4 (some huge Multiplatform changes was added in release 1.4).</p>

<blockquote>
  <p><strong>Disclaimer:</strong> this post is pretty long and I recommend reading one part at a time (it’s 3 parts).</p>

  <p>Personally I hate unfinished blogs that are multiple parts, hence I uploaded all at once. So be assured, you’re getting all parts - right here, right now! :happy:</p>

  <p>Finally, the first part is purely informational about how everything works and the second part is how to actually code the game. The second part is interactive and contains a lot of TODOs.
The third, and final, part covers how we are able to use the same code on JS/Browser &amp; Native</p>
</blockquote>

<p><strong>All the finished code is available <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project">here</a></strong> (open <code class="language-plaintext highlighter-rouge">master</code> if you wish to have the unfinished code).</p>

<h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>First off, what is Kotlin?</p>

<p><img src="https://lh6.googleusercontent.com/z07YTS2Ft_HypvBzChXpX4L1ye3y4ht0x142UCo8q6LGT0EaxZyEFA5hwP3_OV4ZQafkavgMBtRBP3X6RFPpogLTG5uR8J485-o6y1TOZ3xh_7TZkvTb7DOSGqIm5kiIZwPFCZdlLXg" alt=""></p>

<blockquote>
  <p>Image from <a href="https://kotlinlang.org/">kotlinlang.org</a></p>
</blockquote>

<p>By my own account it’s a language that has learned from many mistakes done in the past and tries to extend and embrace the good ones!</p>

<p>The most obvious one solved by Kotlin is “The Billion Dollar Mistake” as the inventor <a href="https://en.wikipedia.org/wiki/Tony_Hoare">Tony Hoare</a> calls it himself, namely <code class="language-plaintext highlighter-rouge">null</code>. Kotlin is not alone about this, but certainly off to a good start!</p>

<p>Some mentionable features on top of this is</p>

<ul>
  <li>
<a href="https://kotlinlang.org/docs/reference/coroutines-overview.html">Coroutines</a> - A more efficient (lightweight) threading model, also called “green threads” sometimes. Feels very natural and easy.</li>
  <li>
<a href="https://kotlinlang.org/docs/reference/data-science-overview.html">Data-Science &amp; Jupyter</a> support</li>
  <li>
<a href="https://kotlinlang.org/docs/reference/extensions.html#extensions">Extension functions</a> - Perhaps my favourite feature, do you feel a class is missing a function? No problem, you’re free to do so!</li>
  <li>Excellent <a href="https://kotlinlang.org/spec/type-inference.html">typing</a> - Perhaps not Scala, but still very good.</li>
  <li>&amp; more!</li>
</ul>

<p>All of this is available through Kotlins Multiplatform effort, where Multiplatform does not mean Mac/Windows/Linux but rather that we can compile into different platforms such as Java Bytecode (JVM), <a href="https://kotlinlang.org/docs/reference/native-overview.html">Native</a>  and <a href="https://kotlinlang.org/docs/reference/js-overview.html">JS/Browser</a>.</p>

<p>Enough praises, let’s get onto how the multiplatform solution actually works through <a href="#Part%201:%20How%20does%20Kotlin%20Multiplatform%20work"><strong>Part 1</strong></a>.</p>

<h1 id="part-1-how-does-kotlin-multiplatform-work">
<a class="anchor" href="#part-1-how-does-kotlin-multiplatform-work" aria-hidden="true"><span class="octicon octicon-link"></span></a>Part 1: How does Kotlin Multiplatform work?</h1>
<p>Let’s begin by understanding exactly what <strong>Native</strong> is?
From the landing page of <a href="https://kotlinlang.org/docs/reference/native-overview.html">kotlinlang.org/native</a>.</p>

<blockquote>
  <p>Kotlin/Native is a technology for compiling Kotlin code to native binaries, which can run without a virtual machine. It is an  <a href="https://llvm.org/">LLVM</a>  based backend for the Kotlin compiler and native implementation of the Kotlin standard library.</p>
</blockquote>

<p>This statement tells us a few things, such as <em>native</em> refering to binary executables that can run on a OS (natively) using no virtual machine or browser!<br>
But in practice?</p>

<p>✔️ Small file size<br>
✔️ No overhead<br>
✔️ Incredibly fast starting-time</p>

<p>As usual it isn’t a win-win situation but you loose some</p>

<p>❌Development speed</p>

<h2 id="llvm">
<a class="anchor" href="#llvm" aria-hidden="true"><span class="octicon octicon-link"></span></a>LLVM</h2>

<p>LLVM is probably the biggest project (compiler) that exists to build native binaries. Languages such as C, C++, Haskell, Rust &amp; Swift compile into native binaries through LLVM.</p>

<p>From the info-box previously,</p>

<blockquote>
  <p><strong>It is an  <a href="https://llvm.org/">LLVM</a>  based backend for the Kotlin compiler</strong> and native implementation of the Kotlin standard library.</p>
</blockquote>

<p>So… What is a backend? More specifically, what is a backend for a compiler?</p>

<h2 id="how-the-kotlin-compiler-works-frontend-to-backend">
<a class="anchor" href="#how-the-kotlin-compiler-works-frontend-to-backend" aria-hidden="true"><span class="octicon octicon-link"></span></a>How the Kotlin Compiler works, Frontend to Backend</h2>

<p>A compiler is like a translator, just as you’d translate Swedish into English a compiler instead translates computer code written in one programming language into another one of lower level, e.g. assembly.</p>

<p>In general all compilers follow the same pattern, and Kotlin is no different. Even though it’s a similar path it’s interesting to learn about, even more if you don’t know how it usually works!<br>
The Kotlin Compiler first compiles Kotlin code into a <em>Intermediate Representation</em>, or <em>IR</em>, which it later turns into Java Bytecode, when targeting the <em>Java Virtual Machine</em> (<em>JVM</em>).</p>

<p><img src="https://user-images.githubusercontent.com/7490199/97027300-d2095900-155a-11eb-9d18-6fb58a0a9699.png" alt="image"></p>

<p>The first part is called the <strong>Compiler Frontend</strong></p>

<h3 id="the-kotlin-compiler-frontend">
<a class="anchor" href="#the-kotlin-compiler-frontend" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Kotlin Compiler Frontend</h3>

<p><img src="https://user-images.githubusercontent.com/7490199/97027463-1137aa00-155b-11eb-9c31-a60e3e25af87.png" alt="image"></p>

<p>The <em>Compiler Frontend</em> turns the Kotlin code into a <em>Intermediate Representation</em> of the code which is represented by a <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a>. The <em>abstract syntax tree</em> in turn is built from concrete syntax, e.g. strings.<br>
The process involves <a href="https://en.wikipedia.org/wiki/Lexical_analysis">lexical analysis</a> which creates tokens and pass it forward to the <a href="https://en.wikipedia.org/wiki/Parsing">parser</a> that finally builds the <em>abstract syntax tree</em>.<br>
For those interested this could be a really fun challenge and learning lesson to implement yourself!</p>

<p>Moving on, the second and final part is called the <strong>Compiler Backend</strong>.</p>

<h3 id="the-kotlin-compiler-backend">
<a class="anchor" href="#the-kotlin-compiler-backend" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Kotlin Compiler Backend</h3>

<p><img src="https://user-images.githubusercontent.com/7490199/97077672-ddee2d00-15e5-11eb-9f71-916c5b2a0544.png" alt="image"></p>

<p>The <em>Compiler Backend</em> turns this abstract syntax tree, or <em>IR</em>, into computer output language.<br>
In the image that is Java Bytecode which is understood by the <em>JVM</em>. The backend is the part that actually optimize code to remove for-loops where applicable, exchange variables into constants and so on.<br>
Just as with the frontend it’s a really good challenge to either implement a backend without optimizations, or focus on a existing one and adding a optimization yourself!</p>

<p>What is interesting about Kotlin is that it has different compiler backends, which means that the <em>IR</em> compile not only into Java Bytecode but also JS/Browser &amp; Native binaries.</p>

<p><img src="https://user-images.githubusercontent.com/7490199/97077776-b8155800-15e6-11eb-8ae6-a83a77253087.png" alt="image"></p>

<blockquote>
  <p><strong>Side-note</strong>: For Native Backend there’s in fact two <em>Intermediate Representations</em>, first Kotlin <em>IR</em> which then compiles into LLVM <em>IR</em>. LLVM finally turns this into a native binary through its own Compiler Backend.<br>
During the final step in LLVM all the optimizations applied to C, C++, Swift &amp; many more is also applied to Kotlin Native code!</p>
</blockquote>

<h2 id="how-kotlin-keeps-multiplatform-clean">
<a class="anchor" href="#how-kotlin-keeps-multiplatform-clean" aria-hidden="true"><span class="octicon octicon-link"></span></a>How Kotlin keeps multiplatform clean</h2>

<p>It might sound messy to target multiple platforms like this, and how could it possibly end up clean?</p>

<p>By using the standard libraries that are included with Kotlin, which includes almost everything you need, and multiplatform-developed community libraries, e.g. <a href="https://github.com/cashapp/sqldelight">SQLDelight</a>, you get code that looks the same and works the same irregardless of target (JS/Browser, Native or the JVM).</p>

<p>To give an example of how Kotlin std-lib works, let’s take one of the most common types - <code class="language-plaintext highlighter-rouge">String</code>.</p>

<p><img src="https://user-images.githubusercontent.com/7490199/97077938-2dcdf380-15e8-11eb-8282-873d80f6178e.png" alt="image"></p>

<p>By using <code class="language-plaintext highlighter-rouge">Kotlin.String</code> rather than the usual <code class="language-plaintext highlighter-rouge">Java.lang.String</code> you do when programming Java you get a type that works on multiple platforms, including some awesome convenience functions. Imagine, you can write native code using <code class="language-plaintext highlighter-rouge">.substring</code>, <code class="language-plaintext highlighter-rouge">.take(n)</code> &amp; <code class="language-plaintext highlighter-rouge">.replace</code> - amazing compared to <code class="language-plaintext highlighter-rouge">c</code> right? :happy:</p>

<p>To put this in context of the compiler, this means that the <em>Compiler Backend</em> automatically maps the <em>IR</em> of a <code class="language-plaintext highlighter-rouge">Kotlin.String</code> into the correct type.</p>

<p>You can take this concept and apply to anything such as IO , network &amp; more - all which are included in the std-lib!</p>

<h2 id="summarizing-how-multiplatform-works">
<a class="anchor" href="#summarizing-how-multiplatform-works" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summarizing how Multiplatform works</h2>

<p>Let’s recollect what we’ve gone through</p>

<ol>
  <li>Kotlin Compiler compiles Kotlin code into a <em>Intermediate Representation</em> (IR) through the <em>Compiler Frontend</em>.
    <ol>
      <li>
<em>IR</em> is a abstract syntax tree.</li>
    </ol>
  </li>
  <li>Kotlin Compiler then goes the <em>Compiler Backend</em> which turns the code into the lower level language, e.g. Java Bytecode, and applies multiple optimisations.</li>
  <li>Kotlin has a std-lib which has functionalities as <code class="language-plaintext highlighter-rouge">Kotlin.String</code>, <code class="language-plaintext highlighter-rouge">Kotlin.List</code>, networking and much more.
    <ol>
      <li>
<code class="language-plaintext highlighter-rouge">Kotlin.String</code> turns into <code class="language-plaintext highlighter-rouge">KString</code> in the case of targeting <em>Native</em>. <code class="language-plaintext highlighter-rouge">KString</code> is Kotlins own native strings with some cool helper methods.</li>
    </ol>
  </li>
</ol>

<p>Native is usually considered “dangerous” and “hard” because of all the quirks like pointers, address space and other.</p>

<p>Kotlin Native deals with <em>memory allocation</em> in the same way as Swift, namely <a href="https://en.wikipedia.org/wiki/Reference_counting"><em>reference counting</em></a> which deallocates objects once they’ve got no references. There’s some advantages such as being really fast, but also downsides such as <em>reference cycles</em> which it handles poorly when compared to the JVM Garbace Collector (GC).</p>

<p>Kotlin also has some really nice convenience syntax such as the <code class="language-plaintext highlighter-rouge">memScope</code>-block.</p>

<h2 id="outro-kotlin-multiplatform-and-why-it-matters">
<a class="anchor" href="#outro-kotlin-multiplatform-and-why-it-matters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Outro: Kotlin Multiplatform and why it matters</h2>

<p>✔️ One code-base for common logic</p>
<ul>
  <li>Serialization logic, e.g. parsing JSON into a data class</li>
  <li>Networking</li>
  <li>Database</li>
</ul>

<p>✔️ Development speed<br>
✔️ Required Knowledge</p>

<p>❌ Still requires some code in said language</p>
<ul>
  <li>Especially for UI</li>
</ul>

<p>So all in all we can share our code between platforms which improves development speed &amp; quality in multiple ways.</p>

<p>The biggest “downside” is that even though we share the code we most likely will need some kind of specific code for the platform, for the GUI on iOS as an example. Perhaps <a href="https://www.jetbrains.com/lp/compose/">compose</a> can help us get closer to that reality soon - who knows.<br>
The final, and perhaps obvious, one I’d like to mention straight away is that platform specific libraries of course are not usable on multiplatform. This includes libraries such as React (JS) &amp; <code class="language-plaintext highlighter-rouge">ncurses</code> (native).</p>

<p>Personally I see Kotlin Multiplatform as a great way to <strong>share core logic</strong> between different targets, but one must use it with care and <strong>not try to force it</strong> into being used everywhere in every way.</p>

<h1 id="part-2-how-to-set-up-multiplatform-and-build-snake">
<a class="anchor" href="#part-2-how-to-set-up-multiplatform-and-build-snake" aria-hidden="true"><span class="octicon octicon-link"></span></a>Part 2: How to set up Multiplatform and build Snake</h1>

<blockquote>
  <p><strong>OBS:</strong> Make sure to have Kotlin 1.4 or higher before starting the project. You can verify version &amp; update through File &gt; Settings &gt; Languages &amp; Frameworks &gt; Kotlin. There you see “current version” and if a newer one is available, make sure it’s at least 1.4 (any higher will work too)!</p>
</blockquote>

<p>First we’ll have to set up a Multiplatform project. The <a href="https://kotlinlang.org/docs/reference/mpp-create-lib.html">official guide</a> is actually really good, and if you’re using IntelliJ it’s a breeze to setup! Just as in the guide make sure to select <code class="language-plaintext highlighter-rouge">Library</code>.<br>
<strong>OBS:</strong> For each target (JVM, JS &amp; Native) select “Template” and choose Application for each.</p>

<p><img src="https://kotlinlang.org/assets/images/reference/mpp/mpp-project-1.png" alt="Select a project template"></p>

<p>Run the build.</p>

<blockquote>
  <p><strong>Side-note:</strong> <code class="language-plaintext highlighter-rouge">gradle</code> is a really good build-tool that I’d like to discuss more. But for now let’s just enjoy the simplicity of how our whole project ‘automagically’ just works and builds as expected while targeting different platforms.</p>
</blockquote>

<h2 id="building-a-jvm-app-snake">
<a class="anchor" href="#building-a-jvm-app-snake" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a JVM App (Snake)</h2>

<p>Let’s start simple, Keep It Simple Stupid (KISS) principle applied, and create a JVM app. JVM has multiple advantages while developing such as</p>

<ol>
  <li>Easy to run on all OS:es</li>
  <li>
<em>Great</em> debugging!</li>
  <li>A ton of resources</li>
</ol>

<p>First off, we need to draw something. This is easiest done through the Swing library which is included in the default jdk, some might call it old but hey - it does the job.Create a file called <code class="language-plaintext highlighter-rouge">main.kt</code> in <code class="language-plaintext highlighter-rouge">src/jvmMain/kotlin</code>.</p>

<p>Swing has a built-in threading solution (almost too bad, because <code class="language-plaintext highlighter-rouge">Coroutines</code> are awesome in Kotlin!) and the best way to start the GUI is by using the existing  <code class="language-plaintext highlighter-rouge">EventQueue</code> class and its <code class="language-plaintext highlighter-rouge">invokeLater</code> function. <code class="language-plaintext highlighter-rouge">invokeLater</code> makes sure the code runs last in the <code class="language-plaintext highlighter-rouge">EventQueue</code> if you add more methods, which makes sense - you want to draw the UI as the final thing.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nc">EventQueue</span><span class="p">.</span><span class="nf">invokeLater</span> <span class="p">{</span>
        <span class="nc">JFrame</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="n">title</span> <span class="p">=</span> <span class="s">"Snake"</span>
            <span class="n">isVisible</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Where the <code class="language-plaintext highlighter-rouge">apply</code> is a context wrapper that takes the object and uses it as context (<code class="language-plaintext highlighter-rouge">this</code>) inside of the block/scope (<code class="language-plaintext highlighter-rouge">{}</code>). See its signature:</p>

<p><code class="language-plaintext highlighter-rouge">inline fun &lt;T&gt; T.apply(block: T.() -&gt; Unit): T</code></p>

<p>This would equate to</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">jframe</span> <span class="p">=</span> <span class="nc">JFrame</span><span class="p">()</span>
<span class="n">jframe</span><span class="p">.</span><span class="n">title</span> <span class="p">=</span> <span class="s">"Snake"</span>
<span class="n">jframe</span><span class="p">.</span><span class="n">isVisible</span> <span class="p">=</span> <span class="k">true</span>
</code></pre></div></div>

<p>in more Java-like syntax. Why use <code class="language-plaintext highlighter-rouge">apply</code>? It allows us to achieve some interesting chaining concepts which I really enjoy.</p>

<p>Now run the <code class="language-plaintext highlighter-rouge">main</code>-function, there should be a green “run”-button at the left, press that. Hopefully it compiles and a window will appear, with the title set to “Snake”.</p>

<p>Awesome! We need to render something inside of the box, a game soon enough, let’s see how we can achieve that.</p>

<p>Adding some minor refactoring and some new classes we can draw something</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Board</span><span class="p">:</span> <span class="nc">JPanel</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">init</span> <span class="p">{</span>
        <span class="nc">TODO</span><span class="p">(</span><span class="s">"""
        - Set background to black
        - Allow focus
        - Set preferredSize to some 200x300
        """</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">GUI</span><span class="p">:</span> <span class="nc">JFrame</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">init</span> <span class="p">{</span>
        <span class="n">title</span> <span class="p">=</span> <span class="s">"Snake"</span>
        <span class="n">isVisible</span> <span class="p">=</span> <span class="k">true</span>
        <span class="n">isResizable</span> <span class="p">=</span> <span class="k">false</span>
        <span class="nf">setLocationRelativeTo</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
        <span class="n">defaultCloseOperation</span> <span class="p">=</span> <span class="nc">EXIT_ON_CLOSE</span>

        <span class="nc">TODO</span><span class="p">(</span><span class="s">"Add the Board to the JFrame, through add()"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nc">EventQueue</span><span class="p">.</span><span class="nf">invokeLater</span> <span class="p">{</span>
        <span class="nc">GUI</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>What are we doing?<br>
<code class="language-plaintext highlighter-rouge">JFrame</code> was refactored <code class="language-plaintext highlighter-rouge">GUI</code> which then is a subclass of <code class="language-plaintext highlighter-rouge">JFrame</code>, with a few extra attributes added such as <code class="language-plaintext highlighter-rouge">defaultCloseOperation = EXIT_ON_CLOSE</code> that makes sure the program exits if we close the window, feel free to test it out!<br>
Further a <code class="language-plaintext highlighter-rouge">Board</code> was added which extends <code class="language-plaintext highlighter-rouge">JPanel</code>, it’s in the <code class="language-plaintext highlighter-rouge">Board</code> the game will be rendered. <br>
Finally, <code class="language-plaintext highlighter-rouge">add(Board())</code> allows us to add our <code class="language-plaintext highlighter-rouge">Board</code>  to the <code class="language-plaintext highlighter-rouge">JFrame</code>.</p>

<p>Run!<br>
Something is not right.. The background seems black enough, but the size is most likely not correct. We can’t even resize as <code class="language-plaintext highlighter-rouge">isResizable=false</code> was set.<br>
Make sure to add <code class="language-plaintext highlighter-rouge">pack()</code> at the end, as in</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">GUI</span><span class="p">:</span> <span class="nc">JFrame</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">init</span> <span class="p">{</span>
        <span class="p">{</span> <span class="cm">/** same code as before */</span> <span class="p">}</span>
        <span class="nf">add</span><span class="p">(</span><span class="nc">Board</span><span class="p">())</span>
        <span class="nf">pack</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>What <code class="language-plaintext highlighter-rouge">pack()</code> does is that it packs and resizes the <code class="language-plaintext highlighter-rouge">JFrame</code> to include all its component(s) and their current size(s).</p>

<p>Super! We’re now able to render our <code class="language-plaintext highlighter-rouge">Board</code> and see the whole board.</p>

<h3 id="drawing-the-snake--apple">
<a class="anchor" href="#drawing-the-snake--apple" aria-hidden="true"><span class="octicon octicon-link"></span></a>Drawing the snake &amp; apple</h3>

<p>We’ve got the canvas (Board), now we just need to get artsy and add a Snake and some Apples!<br>
I’ll keep it simple and will make the Board exist of a few cells, all pretty large. On each cell you either have nothing, Snake or Apple - pretty simple right?<br>
<code class="language-plaintext highlighter-rouge">JPanel</code> has some nice-to-have methods built-in, such as <code class="language-plaintext highlighter-rouge">repaint()</code> which simply repaints the component, which in turns calls <code class="language-plaintext highlighter-rouge">paintComponent(g: Graphics?)</code> to paint/render it.</p>

<blockquote>
  <p><em>Disclaimer:</em>  the code might not be the most idiomatic, but I try to introduce a few concepts.</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Board</span><span class="p">:</span> <span class="nc">JPanel</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">init</span> <span class="p">{</span> <span class="cm">/** same code as before */</span> <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">paintComponent</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nc">Graphics</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">paintComponent</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">g2d</span><span class="p">:</span> <span class="nc">Graphics2D</span> <span class="p">=</span> <span class="n">g</span> <span class="k">as</span><span class="p">?</span> <span class="nc">Graphics2D</span> <span class="o">?:</span> <span class="k">return</span>
        
        <span class="n">g2d</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
        <span class="n">g2d</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="nc">Color</span><span class="p">.</span><span class="nc">GREEN</span>
        <span class="n">g2d</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nc">Rectangle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">g2d</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nc">Rectangle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">g2d</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nc">Rectangle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Once again, let’s dive into what’s happening ‘under the hood’.</p>

<p>First, we override the function <code class="language-plaintext highlighter-rouge">paintComponent</code> which renders <code class="language-plaintext highlighter-rouge">Board</code> layout. The input is a <strong>nullable <code class="language-plaintext highlighter-rouge">Graphics</code></strong>, which is shown by the type having a <code class="language-plaintext highlighter-rouge">?</code> at the end. This is a cool property of Kotlin, if something can be <code class="language-plaintext highlighter-rouge">null</code> it actually is a type. No <code class="language-plaintext highlighter-rouge">Option</code>/<code class="language-plaintext highlighter-rouge">Maybe</code>, just pure type.</p>

<p>Then <code class="language-plaintext highlighter-rouge">Graphics?</code> is cast to non-null <code class="language-plaintext highlighter-rouge">Graphics2D</code> through a safe approach using <code class="language-plaintext highlighter-rouge">as?</code>, without <code class="language-plaintext highlighter-rouge">?</code> the cast can crash, with <code class="language-plaintext highlighter-rouge">?</code> the cast would return <code class="language-plaintext highlighter-rouge">null</code> if failing.</p>

<p>Finally we use a <strong>elvis-expression <code class="language-plaintext highlighter-rouge">?:</code></strong> which is basically a wrapper for <code class="language-plaintext highlighter-rouge">if (null) doThis else doThat</code>, so if the left-hand-side is <code class="language-plaintext highlighter-rouge">null</code> it’ll give the right-hand-side. The right-hand-side in our case is a empty <code class="language-plaintext highlighter-rouge">return</code> statement, meaning that we just make a early-exit. If the value is <em>not</em> <code class="language-plaintext highlighter-rouge">null</code> it’ll give the non-null variant of the type!</p>

<blockquote>
  <p>Example use-case of elvis-operator <code class="language-plaintext highlighter-rouge">?:</code><br>
<code class="language-plaintext highlighter-rouge">val a: Int = 1 ?: 0 // a = 1</code><br>
<code class="language-plaintext highlighter-rouge">val b: Int = null ?: 0 // b = 0</code></p>
</blockquote>

<p>Detailing the code further we now have <code class="language-plaintext highlighter-rouge">g2d: Graphics2D</code> where <code class="language-plaintext highlighter-rouge">Graphics2D</code> which gives us a few nice functions to draw components on the <code class="language-plaintext highlighter-rouge">Board</code>.</p>

<ul>
  <li>We set the scale to 20
    <ul>
      <li>This simplifies the behaviour, we can now use 20x30 grid where each cell is size 1, but it’s scaled into the 200x300 grid.</li>
    </ul>
  </li>
  <li>We use <code class="language-plaintext highlighter-rouge">fill</code> to draw <code class="language-plaintext highlighter-rouge">Rectangle</code>’s with set <code class="language-plaintext highlighter-rouge">Color</code>.</li>
</ul>

<blockquote>
  <p><strong>Side-note:</strong>
For those wondering how you safely execute on <code class="language-plaintext highlighter-rouge">null</code>s by chaining, like you do with Monads (<code class="language-plaintext highlighter-rouge">Option</code>)</p>

  <div class="language-kotlin highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">nullableGraphics</span><span class="p">:</span> <span class="nc">Graphics</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="n">nullableGraphics</span><span class="o">?.</span><span class="nf">scale</span><span class="p">(</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>	<span class="c1">// This is safe! No operation executed if null</span>
</code></pre></div>  </div>
</blockquote>

<p>Summing up, we now know how to render stuff on the <code class="language-plaintext highlighter-rouge">Board</code> and it’s all very static.<br>
The next step is to make the rendering less static and I believe the natural step from now is to create the data structures that’ll contain the game &amp; its state. Then we can make sure the data structures are able to update, so we can render new states.</p>

<h3 id="creating-the-data-structures">
<a class="anchor" href="#creating-the-data-structures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating the data structures</h3>

<p>Data structures are required to have a game state, that is the score and position of everything.</p>

<p>The natural state is <code class="language-plaintext highlighter-rouge">Game</code> which contains everything, let’s begin by creating a <code class="language-plaintext highlighter-rouge">Game</code> structure which contains the size of the <code class="language-plaintext highlighter-rouge">Board</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Game</span><span class="p">(</span><span class="kd">val</span> <span class="py">width</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">height</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Side-note:</strong> A <code class="language-plaintext highlighter-rouge">data class</code> is essentially the same as a  <code class="language-plaintext highlighter-rouge">case class</code> from Scala. And for those who don’t know what a <code class="language-plaintext highlighter-rouge">case class</code> is it’s basically a <code class="language-plaintext highlighter-rouge">class</code> that simplifies a lot of stuff, mainly used as a data structure. <br>
You get <code class="language-plaintext highlighter-rouge">equals</code>, getters &amp; setters, and much more for free.<br>
Anyone from Java knows how awesome this is.</p>
</blockquote>

<p>Moving on we need to define the cells mentioned, something like</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Cell</span><span class="p">(</span><span class="kd">val</span> <span class="py">x</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">y</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span>
</code></pre></div></div>

<p>Wrapping up our current state we got most of what we need, <code class="language-plaintext highlighter-rouge">Game</code> which contains our game state &amp; <code class="language-plaintext highlighter-rouge">Cell</code> which is our co-ordinates.<br>
The next step is to actually draw the <code class="language-plaintext highlighter-rouge">Cell</code>’s and wrap the <code class="language-plaintext highlighter-rouge">Cell</code> in other classes such as <code class="language-plaintext highlighter-rouge">Apple</code> and <code class="language-plaintext highlighter-rouge">Snake</code>.</p>

<p>Let’s add all the required code.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Apples</span><span class="p">(</span><span class="kd">val</span> <span class="py">cells</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">emptySet</span><span class="p">())</span>

<span class="kd">data class</span> <span class="nc">Snake</span><span class="p">(</span><span class="kd">val</span> <span class="py">cells</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">head</span><span class="p">:</span> <span class="nc">Cell</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Take the first cell."</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">tail</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Drop one cell and return the rest."</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">Game</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">width</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">height</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">snake</span><span class="p">:</span> <span class="nc">Snake</span><span class="p">,</span>	<span class="c1">// Adding snake and apples</span>
    <span class="kd">val</span> <span class="py">apples</span><span class="p">:</span> <span class="nc">Apples</span>
<span class="p">)</span>

<span class="kd">class</span> <span class="nc">Board</span><span class="p">:</span> <span class="nc">JPanel</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">game</span><span class="p">:</span> <span class="nc">Game</span> <span class="p">=</span> <span class="nc">Game</span><span class="p">(</span>
        <span class="mi">20</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">,</span>
        <span class="nc">Snake</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),)),</span>
        <span class="nc">Apples</span><span class="p">(</span><span class="nf">setOf</span><span class="p">(</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>
    <span class="p">)</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="n">background</span> <span class="p">=</span> <span class="nc">Color</span><span class="p">.</span><span class="n">black</span>
        <span class="n">isFocusable</span> <span class="p">=</span> <span class="k">true</span>
        <span class="n">preferredSize</span> <span class="p">=</span> <span class="nc">Dimension</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">paintComponent</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nc">Graphics</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">paintComponent</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">g2d</span> <span class="p">=</span> <span class="n">g</span> <span class="k">as</span><span class="p">?</span> <span class="nc">Graphics2D</span> <span class="o">?:</span> <span class="k">return</span>
        <span class="n">g2d</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>

        <span class="n">g2d</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="nc">Color</span><span class="p">.</span><span class="nc">GREEN</span>
        <span class="n">game</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">tail</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">cell</span> <span class="p">-&gt;</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Render the cells using the previously used technique"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nc">TODO</span><span class="p">(</span><span class="s">"Render the head using the color YELLOW"</span><span class="p">)</span>

        <span class="nc">TODO</span><span class="p">(</span><span class="s">"Render the apples using the color RED"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Fixing the added <code class="language-plaintext highlighter-rouge">TODO</code>s and keeping the same <code class="language-plaintext highlighter-rouge">GUI</code> &amp; <code class="language-plaintext highlighter-rouge">fun main</code> we can now run the code. You should be seeing something like</p>

<p><img src="https://user-images.githubusercontent.com/7490199/97808473-5c427300-1c67-11eb-9fa9-9110f596533b.png" alt="image"></p>

<p>Pretty cool right!? We’ve got<br>
✔️ Rendering<br>
✔️ Data Structures</p>

<p>What’s left?</p>

<ol>
  <li>A game loop</li>
  <li>Ability to actually move the data structures ( <code class="language-plaintext highlighter-rouge">Snake</code>)</li>
</ol>

<h4 id="adding-a-direction">
<a class="anchor" href="#adding-a-direction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding a Direction</h4>

<p>To be able to move we need to know what directions to move in. In my humble opinion this is simplest done through a <code class="language-plaintext highlighter-rouge">Enum</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="kd">class</span> <span class="nc">Direction</span> <span class="p">{</span>
    <span class="nc">UP</span><span class="p">,</span>
    <span class="nc">DOWN</span><span class="p">,</span>
    <span class="nc">LEFT</span><span class="p">,</span>
    <span class="nc">RIGHT</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Simple enough. But let’s make it better, even though pre-optimization is the root of all evil it is sometimes fun <img class="emoji" title=":grinning:" alt=":grinning:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f600.png" height="20" width="20">.<br>
Enums in Kotlin are pretty awesome, they can both keep values and have methods! Let’s add <code class="language-plaintext highlighter-rouge">dx</code> and <code class="language-plaintext highlighter-rouge">dy</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="kd">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="kd">val</span> <span class="py">dx</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">dy</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// --&gt;</span>
    <span class="c1">// |</span>
    <span class="c1">// v</span>
    <span class="nc">UP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="nc">DOWN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="nc">LEFT</span><span class="p">(-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="nc">RIGHT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Through <code class="language-plaintext highlighter-rouge">dx</code> and <code class="language-plaintext highlighter-rouge">dy</code> we can add it to the current cell to move in the direction which <code class="language-plaintext highlighter-rouge">Direction</code> is!</p>

<p>Updating <code class="language-plaintext highlighter-rouge">Snake.kt</code> &amp; <code class="language-plaintext highlighter-rouge">Cell.kt</code> to have <code class="language-plaintext highlighter-rouge">Cell</code> with <code class="language-plaintext highlighter-rouge">Direction</code> and some <code class="language-plaintext highlighter-rouge">turn</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Cell</span><span class="p">(</span><span class="kd">val</span> <span class="py">x</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">y</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">move</span><span class="p">(</span><span class="n">direction</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">)</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Create new cell which moves in direction. OBS: Remember Direction now has dx, dy!"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">Snake</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">cells</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;,</span>
    <span class="kd">val</span> <span class="py">direction</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">,</span> <span class="c1">// new attribute</span>
    <span class="kd">val</span> <span class="py">eatenApples</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// new attribute</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">move</span><span class="p">():</span> <span class="nc">Snake</span> <span class="p">{</span>
    	<span class="kd">val</span> <span class="py">newHead</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Move head"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">newTail</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Move tail!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Create a new Snake with the updated position!"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">fun</span> <span class="nf">turn</span><span class="p">(</span><span class="n">newDirection</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">?)</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Make sure to turn correctly"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is all fine &amp; dandy, but there is some improvements to be made that’ll clean up the code.<br>
I mentioned that Kotlin <code class="language-plaintext highlighter-rouge">Enums</code> can have methods, which is awesome. We can simplify the <code class="language-plaintext highlighter-rouge">turn</code>-logic by adding a method to <code class="language-plaintext highlighter-rouge">Direction</code>, namely <code class="language-plaintext highlighter-rouge">isOppositeTo</code>. See the code below.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="kd">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="kd">val</span> <span class="py">dx</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">dy</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/** Same code as previously */</span>

    <span class="k">fun</span> <span class="nf">isOppositeTo</span><span class="p">(</span><span class="n">that</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">dx</span> <span class="p">+</span> <span class="n">that</span><span class="p">.</span><span class="n">dx</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span> <span class="n">dy</span> <span class="p">+</span> <span class="n">that</span><span class="p">.</span><span class="n">dy</span> <span class="p">==</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Right, we can now turn the snake and render the game. We need the <code class="language-plaintext highlighter-rouge">Game</code>-state to update to actually re-render the updated Snake, let’s add a <code class="language-plaintext highlighter-rouge">update</code>-function that does this.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">update</span><span class="p">(</span><span class="n">direction</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">?):</span> <span class="nc">Game</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"""
    Make sure to
    	1. Turn snake in direction
    	2. Move
    	3. Update the game state by returning Game
    """</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And our GUI</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Board</span><span class="p">:</span> <span class="nc">JPanel</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">dir</span><span class="p">:</span> <span class="nc">Direction</span> <span class="p">=</span> <span class="nc">Direction</span><span class="p">.</span><span class="nc">RIGHT</span>
    <span class="kd">var</span> <span class="py">game</span><span class="p">:</span> <span class="nc">Game</span> <span class="p">=</span> <span class="nc">Game</span><span class="p">(</span>
        <span class="mi">20</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">,</span>
        <span class="nc">Snake</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),),</span> <span class="n">dir</span><span class="p">),</span>
        <span class="nc">Apples</span><span class="p">(</span><span class="nf">setOf</span><span class="p">(</span><span class="nc">Cell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>
    <span class="p">)</span>
    
    <span class="nf">init</span> <span class="p">{</span>
        <span class="nf">addKeyListener</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">KeyAdapter</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">keyPressed</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">KeyEvent</span><span class="p">?)</span> <span class="p">{</span>
                <span class="n">dir</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">e</span><span class="o">?.</span><span class="n">keyCode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nc">VK_I</span><span class="p">,</span> <span class="nc">VK_UP</span><span class="p">,</span> <span class="nc">VK_W</span> <span class="p">-&gt;</span> <span class="nc">Direction</span><span class="p">.</span><span class="nc">UP</span>
                    <span class="k">else</span> <span class="p">-&gt;</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Add the other key bindings. Reflect of how the object works and what is happening."</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">game</span> <span class="p">=</span> <span class="n">game</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
                <span class="nf">repaint</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In our <code class="language-plaintext highlighter-rouge">init</code> (equal to a constructor) we add a <code class="language-plaintext highlighter-rouge">keyListener</code> which will listen on whenever we move. We moved <code class="language-plaintext highlighter-rouge">game</code> to be a <code class="language-plaintext highlighter-rouge">var</code> which allows us to change the reference.</p>

<blockquote>
  <p><strong>Side-note:</strong> The difference between a <code class="language-plaintext highlighter-rouge">val</code> and <code class="language-plaintext highlighter-rouge">var</code> is not about immutability of the value, but rather that you cannot change the pointer to the object. By using <code class="language-plaintext highlighter-rouge">val</code> the compiler don’t allow you to change the reference.</p>

  <div class="language-kotlin highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">a</span> <span class="p">=</span> <span class="mi">1</span>
<span class="n">a</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// CRASH -- This is not allowed</span>
<span class="kd">var</span> <span class="py">b</span> <span class="p">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// b = 3, this is allowed.</span>
</code></pre></div>  </div>

  <p>Please note that this means that if your object is mutable, you can mutate the state of the object even though it’s a <code class="language-plaintext highlighter-rouge">val</code>.</p>
</blockquote>

<p>Why put <code class="language-plaintext highlighter-rouge">game</code> on a <code class="language-plaintext highlighter-rouge">var</code> you might ask? Otherwise how would we update our <code class="language-plaintext highlighter-rouge">Game</code> as the data structure itself is “immutable”, i.e. cannot be changed, which would mean that we’d need to add a new <code class="language-plaintext highlighter-rouge">Game</code> object each time and save it on the stack (never cleaning it up) and that’d pretty fast make the application crash because of <code class="language-plaintext highlighter-rouge">out of memory</code>.</p>

<p>Finally, we update the game by calling our created <code class="language-plaintext highlighter-rouge">update</code>-method and then we use <code class="language-plaintext highlighter-rouge">repaint()</code> which draws the components!</p>

<blockquote>
  <p><strong>Remember:</strong> <code class="language-plaintext highlighter-rouge">paintComponent</code> draws the canvas (game), so whenever <code class="language-plaintext highlighter-rouge">repaint</code> is called <code class="language-plaintext highlighter-rouge">paintComponent</code> draws the game again based on the <code class="language-plaintext highlighter-rouge">game</code> and <code class="language-plaintext highlighter-rouge">cell</code>’s in the game.</p>
</blockquote>

<p>In conclusion this gives us an incredibly simple game, the snake moves whenever we press a key as we <em>still don’t have a game loop</em> based on time. So how do we add a game loop based on time?</p>

<p>The JVM got you covered! In the <code class="language-plaintext highlighter-rouge">keyListener</code> remove the update &amp; repaint, then add a <code class="language-plaintext highlighter-rouge">timer </code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">fixedRateTimer</span><span class="p">(</span><span class="nc">TODO</span><span class="p">(</span><span class="s">"Explore options to use for the timer and how they work"</span><span class="p">))</span> <span class="p">{</span>
	<span class="nc">TODO</span><span class="p">(</span><span class="s">"Insert a game loop here, essentially the same as done in the keyListener previously!"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Run the game! …amazing right?</p>

<p>We now move our snake, and it moves by itself if we don’t. 
But the game is still pretty boring… We never die, no apples can be eaten and finally no new apples appear. We have a few additions to make to make the game a bit challenging..</p>

<p>Let’s start by fixing the apples. Update the <code class="language-plaintext highlighter-rouge">Apples.kt</code> to randomly add apples to the board when calling <code class="language-plaintext highlighter-rouge">grow()</code>.</p>

<blockquote>
  <p>To simplify the logic we use a <code class="language-plaintext highlighter-rouge">set</code> which means that all apples added are unique.</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Apples</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">width</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">height</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">cells</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">emptySet</span><span class="p">(),</span>
    <span class="kd">val</span> <span class="py">growthSpeed</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1">// this could actually be to only spawn apple when there is no other apple. Up to user</span>
    <span class="kd">val</span> <span class="py">random</span><span class="p">:</span> <span class="nc">Random</span> <span class="p">=</span> <span class="nc">Random</span>	<span class="c1">// Once again, Kotlin provides a superb class, in this case a Random wrapper that works on JVM, JS &amp; Native - cool right?</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">grow</span><span class="p">():</span> <span class="nc">Apples</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"""
        If we have a random number greater than growthSpeed, return no update. 
        Otherwise add a new cell.
        """</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we should allow the Snake to eat them, make sure to add <code class="language-plaintext highlighter-rouge">eat(apples: Apples)</code> method and implement it for <code class="language-plaintext highlighter-rouge">Snake.kt</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">eat</span><span class="p">(</span><span class="n">apples</span><span class="p">:</span> <span class="nc">Apples</span><span class="p">):</span> <span class="nc">Pair</span><span class="p">&lt;</span><span class="nc">Snake</span><span class="p">,</span> <span class="nc">Apples</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"""
    If our head is on a Apple location, return a pair of Snake and Apple untouched.
    Otherwise make sure to remove the apple from apples and increase body size of snake!
    """</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At the end of all this we need the <code class="language-plaintext highlighter-rouge">Game.kt</code> to allow this logic to be used. This is done through updating <code class="language-plaintext highlighter-rouge">update</code> to allow the snake to <code class="language-plaintext highlighter-rouge">eat</code> apples and also <code class="language-plaintext highlighter-rouge">grow</code> apples to add new ones.</p>

<p>Great! We can eat apples, add new apples and all. But we’re still pretty invincible and we’ll just keep going forever. 
We need to make sure that the end can be lost, let’s do it by adding a new attribute <code class="language-plaintext highlighter-rouge">isOver</code> to <code class="language-plaintext highlighter-rouge">Game.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">score</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Score based on snakes size, e.g. cell size"</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">isOver</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Game is over if snake head in tail or snake head not on the map!"</span><span class="p">)</span>

<span class="k">fun</span> <span class="nf">update</span><span class="p">(</span><span class="n">dir</span><span class="p">:</span> <span class="nc">Direction</span><span class="p">):</span> <span class="nc">Game</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isOver</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span>
    <span class="p">{</span> <span class="cm">/** same code as was here before */</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="wrapping-up-the-code-with-some-minor-refactoring--new-functionality">
<a class="anchor" href="#wrapping-up-the-code-with-some-minor-refactoring--new-functionality" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrapping up the code with some minor refactoring / new functionality</h2>

<p>Kotlin has a wonderful concept of <strong>extension functions</strong>, which simply is incredible. An extension function extends a class with new functionality. Did you ever wish <code class="language-plaintext highlighter-rouge">Double</code> had a rounding to string? <code class="language-plaintext highlighter-rouge">fun Double.roundTo(n: Int): String = "%.${decimals}f".format(this)</code> solves this for you! Now your <code class="language-plaintext highlighter-rouge">Double</code>’s automatically gives you a hint to use <code class="language-plaintext highlighter-rouge">.roundTo</code> as one of <code class="language-plaintext highlighter-rouge">Double</code>’s built-in functions!</p>

<p>With these we can update our main-method to be a tiny bit cleaner.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g2d</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="nc">Color</span><span class="p">.</span><span class="nc">GREEN</span>
<span class="n">game</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">tail</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">cell</span> <span class="p">-&gt;</span> <span class="n">g2d</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nc">Rectangle</span><span class="p">(</span><span class="n">cell</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cell</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">}</span>

<span class="c1">// Turns into --&gt;</span>

<span class="k">fun</span> <span class="nc">Graphics2D</span><span class="p">.</span><span class="nf">renderCells</span><span class="p">(</span><span class="n">color</span><span class="p">:</span> <span class="nc">Color</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="nc">Iterable</span><span class="p">&lt;</span><span class="nc">Cell</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">color</span>
    <span class="n">cells</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">cell</span> <span class="p">-&gt;</span> <span class="nf">fill</span><span class="p">(</span><span class="nc">Rectangle</span><span class="p">(</span><span class="n">cell</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cell</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span><span class="err">
</span><span class="cm">	Which allows us to just call `g2d.renderCells(Color.GREEN, game.snake.tail)` etc.</span><span class="err">
</span><span class="cm">*/</span>
</code></pre></div></div>

<p><strong>What more improvements can be made?</strong></p>

<p>Exercises left for the reader:</p>

<ol>
  <li>Add Score on the loosing screen</li>
  <li>Add a win-condition (basically impossible, but taking all apples)</li>
  <li>Reinforcement learning to train a bot (might be a future blog!)</li>
  <li>Better &amp; cleaner code!</li>
</ol>

<h1 id="part-3-true-multiplatform-moving-to-js--native">
<a class="anchor" href="#part-3-true-multiplatform-moving-to-js--native" aria-hidden="true"><span class="octicon octicon-link"></span></a>Part 3: True multiplatform (moving to JS &amp; Native)</h1>

<p>I’ll begin by saying that this part is more of a reader exercise. If you want the finished code please go to the <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project">GitHub repository</a>.<br>
The idea is that this part will be solved by yourself during the workshop this is intended for.</p>

<p>All the snake-related code that isn’t in your <code class="language-plaintext highlighter-rouge">main.kt</code>-file should be moved into <code class="language-plaintext highlighter-rouge">src/commonMain/kotlin</code> which makes it <strong>multiplatform</strong>-code. This means that it can target JS, Native &amp; JVM instantly!</p>

<blockquote>
  <p><strong>Side-note:</strong> because all the functionality for the Data Structures (e.g. <code class="language-plaintext highlighter-rouge">take</code>, <code class="language-plaintext highlighter-rouge">List</code>, <code class="language-plaintext highlighter-rouge">Random</code>) exists in Kotlin std-lib it’s automatically possible to use in multiplatform.</p>
</blockquote>

<p>This is not true all the time, if we use platform-specific code. Our platform-specific code, tied with the JVM, is the <code class="language-plaintext highlighter-rouge">timer</code> and <code class="language-plaintext highlighter-rouge">Swing</code> which means that our whole GUI is tied to the JVM.</p>

<p>When the code has been migrated and import-paths are updated, run the JVM app again and validate that everything works.</p>

<h2 id="jsbrowser-target">
<a class="anchor" href="#jsbrowser-target" aria-hidden="true"><span class="octicon octicon-link"></span></a>JS/Browser target</h2>

<p>Now create <code class="language-plaintext highlighter-rouge">src/jsMain/kotlin/main.kt</code>.</p>

<p>In this file we need to define how to draw the browser-based GUI. Some key methods, for the full code check out the git repository.</p>

<p><strong>KeyListener</strong>
<code class="language-plaintext highlighter-rouge">document.onkeydown = { event -&gt; onkeydown(event).also { keyDir -&gt; dir = keyDir } }</code> where <code class="language-plaintext highlighter-rouge">onkeydown</code> is your own method that handles key-events.</p>

<p><strong>Timer</strong> 
<code class="language-plaintext highlighter-rouge">window.setInterval({ game = game.update(dir); render(canvas, game) }, 200)</code></p>

<p><strong>Canvas</strong></p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">canvas</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s">"snake-canvas"</span><span class="p">)</span> <span class="k">as</span> <span class="nc">HTMLCanvasElement</span>
<span class="kd">val</span> <span class="py">ctx</span> <span class="p">=</span> <span class="n">canvas</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="s">"2d"</span><span class="p">)</span> <span class="k">as</span> <span class="nc">CanvasRenderingContext2D</span>
</code></pre></div></div>

<p>On this <code class="language-plaintext highlighter-rouge">ctx</code> from the canvas you can use <code class="language-plaintext highlighter-rouge">fillRect</code> to draw rectangles, and <code class="language-plaintext highlighter-rouge">fillStyle</code> to set color.</p>

<p><strong>HTML-Canvas</strong> <br>
<code class="language-plaintext highlighter-rouge">&lt;canvas id="snake-canvas" width="400px" height="300px"&gt;&lt;/canvas&gt;</code> (put in <code class="language-plaintext highlighter-rouge">index.html</code>)</p>

<p>The game is run through <code class="language-plaintext highlighter-rouge">./gradlew jsBrowserRun</code>, or selecting the gradle-icon at the top right (elephant) and typing <code class="language-plaintext highlighter-rouge">jsBrowserRun</code>.</p>

<p>And the code for the GUI using these components is pretty much exactly the same as in Swing to be honest.</p>

<p>Congratulations, you have now achieved creating a desktop game and a browser game!</p>

<h2 id="native-target">
<a class="anchor" href="#native-target" aria-hidden="true"><span class="octicon octicon-link"></span></a>Native target</h2>

<p>And onto our final target, Native Binary, that runs completely without a browser or a virtual machine.</p>

<p>For the Native target the GUI will be supported through the library <code class="language-plaintext highlighter-rouge">ncurses</code> which unfortunately is only supported on Linux &amp; MacOS. If you’ve windows you can solve this through <em>Windows Subsystem for Linux</em> (WSL).</p>

<p>Begin by creating <code class="language-plaintext highlighter-rouge">src/nativeMain/kotlin/main.kt</code>.</p>

<p>To begin, in the main-function do the following:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">maint</span><span class="p">():</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="nf">memScoped</span> <span class="p">{</span>
    <span class="c1">// insert code</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">memScoped</code> part means that all memory allocated in the block is automatically disposed at the end, incredibly useful! :happy:</p>

<p>Then reading how to use <code class="language-plaintext highlighter-rouge">ncurses</code> we can figure out how to init this. The final end-goal being</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="nf">memScoped</span> <span class="p">{</span>
    <span class="nf">initscr</span><span class="p">()</span>

    <span class="nf">defer</span> <span class="p">{</span> <span class="nf">endwin</span><span class="p">()</span> <span class="p">}</span>
    <span class="nf">noecho</span><span class="p">()</span>
    <span class="nf">curs_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nf">halfdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="kd">var</span> <span class="py">game</span><span class="p">:</span> <span class="nc">Game</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">window</span> <span class="p">=</span> <span class="nf">newwin</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">height</span> <span class="p">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">width</span> <span class="p">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">!!</span>
    <span class="nf">defer</span> <span class="p">{</span> <span class="nf">delwin</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="py">input</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="nf">toChar</span><span class="p">()</span> <span class="p">!=</span> <span class="sc">'q'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">window</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

        <span class="n">input</span> <span class="p">=</span> <span class="nf">wgetch</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">direction</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="nf">toChar</span><span class="p">())</span> <span class="p">{</span>
        	<span class="sc">'i'</span> <span class="p">-&gt;</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">game</span> <span class="p">=</span> <span class="n">game</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">CPointer</span><span class="p">&lt;</span><span class="nc">WINDOW</span><span class="p">&gt;.</span><span class="nf">draw</span><span class="p">(</span><span class="n">game</span><span class="p">:</span> <span class="nc">Game</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">wclear</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nf">box</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0u</span><span class="p">,</span> <span class="mi">0u</span><span class="p">)</span>

    <span class="n">game</span><span class="p">.</span><span class="n">apples</span><span class="p">.</span><span class="n">cells</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="nf">mvwprintw</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">game</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">tail</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="nf">mvwprintw</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"o"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">game</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="nf">let</span> <span class="p">{</span> <span class="nf">mvwprintw</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"Q"</span><span class="p">)</span> <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">isOver</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">mvwprintw</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">"Game Over"</span><span class="p">)</span>
        <span class="nf">mvwprintw</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">"Your score is ${game.score}"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">wrefresh</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Try running it in the terminal.</p>

<p>This blog was created as a companion to a workshop I’m gonna do at AFRY, it has a bit more content including a presentation in person.</p>

<p>All the finished code is available <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project">here</a>, if you prefer the unfinished code head to <a href="https://github.com/londogard/snake-js-jvm-native">master-branch</a>.</p>

<p>Thanks!</p>

<p>~Hampus</p>

  </div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="londogard/londogard" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script><a class="u-url" href="/gradle/kotlin/game/multiplatform/2020/11/07/snake-kotlin-multiplatform.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A blog with a focus on Deep Learning, JVM and Performance.</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list"><li><a rel="me" href="https://github.com/londogard" title="londogard"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
