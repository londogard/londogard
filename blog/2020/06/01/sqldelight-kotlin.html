<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Londogard Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Londogard Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-react-helmet="true">SQL - Different Abstraction Levels (&amp; how I came to love SQLDelight) | Londogard Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.londogard.com/blog/2020/06/01/sqldelight-kotlin"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="keywords" content="nlp, kotlin, jvm, deep-learning, machine-learning, blog"><meta data-react-helmet="true" property="og:title" content="SQL - Different Abstraction Levels (&amp; how I came to love SQLDelight) | Londogard Blog"><meta data-react-helmet="true" name="description" content="In this post different abstraction levels of SQL is discussed with the final SQLDelight which turns the abstraction into the reverse."><meta data-react-helmet="true" property="og:description" content="In this post different abstraction levels of SQL is discussed with the final SQLDelight which turns the abstraction into the reverse."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-06-01T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/lundez"><meta data-react-helmet="true" property="article:tag" content="jvm,kotlin,db,multiplatform"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.londogard.com/blog/2020/06/01/sqldelight-kotlin"><link data-react-helmet="true" rel="alternate" href="https://blog.londogard.com/blog/2020/06/01/sqldelight-kotlin" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.londogard.com/blog/2020/06/01/sqldelight-kotlin" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2b920993.css">
<link rel="preload" href="/assets/js/runtime~main.c03bf689.js" as="script">
<link rel="preload" href="/assets/js/main.16001965.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="Londogard logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/favicon.ico" alt="Londogard logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Londogard Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/blog/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/presentations">Presentations</a></div><div class="navbar__items navbar__items--right"><a href="https://londogard.com/about" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>About<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://londogard.com/projects" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Londogard Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/londogard" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/11/06/babymonitor-pt-1">Babymonitor #1</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/09/07/docker-simplified-presentation">Docker (Presentation)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/gpt2-snapsvisor">GPT2-snapsvisor - Generating Swedish Drinking Songs</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/timeseries-pt-3">Forecasting Crypto Prices using Deep Learning (Time Series #3)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/timeseries-pt-2">Predicting Stock Prices using classical machine Learning (Time Series #2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">SQL - Different Abstraction Levels (&amp; how I came to love SQLDelight)</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2020</time> Â· <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/lundez" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://github.com/lundez.png" alt="Hampus LondÃ¶gÃ¥rd"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lundez" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hampus LondÃ¶gÃ¥rd</span></a></div><small class="avatar__subtitle" itemprop="description">Main Contributor of Londogard</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>In this blog I&#x27;ll cover a few different abstraction levels of database access, focusing purely on SQL and not NoSQL / Reddis or anything like that. The purpose is to share the knowledge that there exist these types of abstractions and they do exist in all or at least most of the popular languages.</p><p>I&#x27;ll try to move from \&quot;raw SQL\&quot; to the modern \&quot;Object-Relational Mapping\&quot;-style, a.k.a ORM. </p><p>In the end I wish to make a short piece leaving out a lot of details but maintaining a feel of each style and some pros/cons. I bet you already guessed my preferred approach straight from the title ðŸ˜‰.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="how-to-interact-with-a-sql-database-from-a-programming-language">How to interact with a SQL Database from a programming language<a class="hash-link" href="#how-to-interact-with-a-sql-database-from-a-programming-language" title="Direct link to heading">â€‹</a></h3><p>Structured Query Language (SQL) is as the name, once spelled out, a Domain Specific Language (DSL) just like regex. It&#x27;s basically a programming language written to facilitate and simplify the experience with the underlying engine. By using a DSL you gain capabilities that would be natural to integrate with most languages, and it also makes the engine do the same with the same code across languages. </p><p>I think that Regex and SQL are the most famous DSLs and for good reason, having regex work (almost) the same across languages simplifies the guides and the same applies to SQL.</p><p>Going forward let&#x27;s see how we communicate with a SQL-db from a programming language like Java using their famous jdbc (Java Database Connectivity) which is the driver that communicates with the db.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      System.out.println(\&quot;Connecting to database...\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //STEP 4: Execute a query</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      System.out.println(\&quot;Creating statement...\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stmt = conn.createStatement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String sql;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sql = \&quot;SELECT id, first, last, age FROM Employees\&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ResultSet rs = stmt.executeQuery(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //STEP 5: Extract data from result set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      while(rs.next()){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Retrieve by column name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         int id  = rs.getInt(\&quot;id\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         int age = rs.getInt(\&quot;age\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         String first = rs.getString(\&quot;first\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         String last = rs.getString(\&quot;last\&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Display values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         System.out.print(\&quot;ID: \&quot; + id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         System.out.print(\&quot;, Age: \&quot; + age);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         System.out.print(\&quot;, First: \&quot; + first);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         System.out.println(\&quot;, Last: \&quot; + last);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //STEP 6: Clean-up environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rs.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stmt.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      conn.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } catch (SQLException se) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ....</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Not very convenient right? Personally I think this looks horrible, it&#x27;s filled with horrible getters &amp; setters like we&#x27;re stuck in the Middle Ages or something.
Personally my mind directly flows to serialization and how that must work somehow with databases, and that&#x27;s right - we can move into the future today! </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="moving-one-abstraction-level-up">Moving one abstraction level up<a class="hash-link" href="#moving-one-abstraction-level-up" title="Direct link to heading">â€‹</a></h3><p>Welcome <a href="https://developer.android.com/topic/libraries/architecture/room" target="_blank" rel="noopener noreferrer">Room</a> &amp; <a href="http://scala-slick.org/" target="_blank" rel="noopener noreferrer">slick</a> (two libraries I&#x27;ve experience with) to the room!
Both of these libraries provide a type of serialization to classes and more convenient syntax to write the code. The first one heavily leans on annotation to make it work while the other one uses a more slick approach of \&quot;copying\&quot; the way you work with the standard Scala Collections (<code>filter, map, flatMap, reduce</code> etc). </p><p>I&#x27;d say that both do count as ORMs but they&#x27;re still not as abstract as other solutions such as <em>peewee</em> which we&#x27;ll discuss later. Let&#x27;s get into Room and how it works. First you define entities like a class with the added annotation <code>@Entity</code> and then you define a <em>Data Access Object</em> (DAO) to interact with the table / object. The DAO is where you define your queries, let&#x27;s take a look.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Dao</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface UserDao {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Query(\&quot;SELECT * FROM user\&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun getAll(): List&lt;User&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Query(\&quot;SELECT * FROM user WHERE uid IN (:userIds)\&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun loadAllByIds(userIds: IntArray): List&lt;User&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In my opinion this approach strikes a really good balance between simple-to-use but still powerful and very configurable because you still use SQL, a bonus here is that it&#x27;s safe from SQL-injection as you&#x27;re making use of so-called <code>prepared-statements</code> (<a href="https://en.wikipedia.org/wiki/Prepared_statement" target="_blank" rel="noopener noreferrer">wikipedia</a>). The biggest drawback is that it&#x27;s hard to write easy-to-read SQL in the annotation and for the annotation-haters we&#x27;ve a lot of annotations (which often slows down the compile-time noticeably among other things).</p><p>Moving on we&#x27;ve <code>slick</code> which is also a really cool approach! <code>slick</code> allows you to this but instead you write your queries in something that feels like using the normal Scala Collection library. This allows you to use <code>map</code>, <code>filter</code>, <code>reduce</code> etc to create queries, and even <code>for-comprehension</code>. Let&#x27;s see!</p><div class="codeBlockContainer_I0IT language-scala theme-code-block"><div class="codeBlockContent_wNvx scala"><pre tabindex="0" class="prism-code language-scala codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// Read all coffees and print them to the console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">println(\&quot;Coffees:\&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db.run(coffees.result).map(_.foreach {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case (name, supID, price, sales, total) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println(\&quot;  \&quot; + name + \&quot;\\t\&quot; + supID + \&quot;\\t\&quot; + price + \&quot;\\t\&quot; + sales + \&quot;\\t\&quot; + total)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Read coffee with price lower than 9 and join with matching supplier using for-comprehension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val q2 = for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  c &lt;- coffees if c.price &lt; 9.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s &lt;- suppliers if s.id === c.supID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} yield (c.name, s.name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// A find using filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def find(id: Int) = db.run(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .filter(_.id === id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .result.headOption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Pretty slick right?</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="moving-another-level-up-python--peewee">Moving another level up (Python + Peewee)<a class="hash-link" href="#moving-another-level-up-python--peewee" title="Direct link to heading">â€‹</a></h3><p>Ok, maybe it&#x27;s not actually moving one level up from <code>slick</code> but I&#x27;d say it&#x27;s still a little bit further away from raw SQL as we make more use of objects, in the case of <code>slick</code> you can more easily see the generated SQL-code. Let&#x27;s take a look at <a href="http://docs.peewee-orm.com/en/latest/index.html" target="_blank" rel="noopener noreferrer">peewee</a> which supports most databases (sqlite, mysql, postgresql and cockroachdb).</p><p>So where do we begin? Create the database and tables!
It&#x27;s done by initiating a database and then creating different classes which each maps to their own tables automatically.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">db = SqliteDatabase(&#x27;people.db&#x27;) # create the db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Person(Model):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = CharField()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    birthday = DateField()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class Meta:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        database = db # This model uses the \&quot;people.db\&quot; database.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Pet(Model):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    owner = ForeignKeyField(Person, backref=&#x27;pets&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = CharField()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    animal_type = CharField()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class Meta:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        database = db # this model uses the \&quot;people.db\&quot; database</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And how would one create entries and then query them? It&#x27;s simply done through object creation as in the following examples.</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">uncle_bob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Bob&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> birthday</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1960</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uncle_bob</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Sometimes the class already has a \&quot;create method\&quot; as in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Sarah&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> birthday</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1980</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># And create a pet which belongs to uncle_bob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bob_dog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Pet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">uncle_bob</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Doggy&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> animal_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;dog&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And to query the tables we also make use of the object fully, as in the following small example.</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bobby </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bob&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># or all persons!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> person </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> Person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we&#x27;ve gone through the different abstraction layers that you usually see available in most languages. Going forward I&#x27;d like to show SQLDelight which turns the abstraction a little bit upside down.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="sqldelight-abstraction-level-left-to-the-right">SQLDelight: Abstraction level left to the right<a class="hash-link" href="#sqldelight-abstraction-level-left-to-the-right" title="Direct link to heading">â€‹</a></h3><p>In SQLDelight I&#x27;d say we get the ideal balance of abstraction and configurability. We deal with raw SQL which is both a pro &amp; con, people will need to know SQL unlike in a abstracted ORM but you also get the full potential and it&#x27;s really simple to do complex joins (which is really messy in ORMs).</p><p>I was delighted at how simple it was to use from my Kotlin code while also providing a simple way to write my DB-interactions. No confusion and there&#x27;s a million guides out there showing how you write SQL code for complex joins if you ever need a hand.</p><p>Let&#x27;s begin with how you define a table and queries, through a so-called <code>.sq</code>-file.</p><div class="codeBlockContainer_I0IT language-sqlite theme-code-block"><div class="codeBlockContent_wNvx sqlite"><pre tabindex="0" class="prism-code language-sqlite codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- .sq-file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE person (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name TEXT NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  birthday DATE NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- You can actually also insert a Person directly in this file if you&#x27;d like using the normal SQL insert statement.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">selectAll:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM person;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insert:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO person(name, birthday)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VALUES (?, ?);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insertPerson:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO person(name, birthday)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VALUES ?;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For those that don&#x27;t know SQL this does the following</p><ol><li>Define the table</li><li>Create queries on the table<ol><li>These queries makes use of the custom format <code>methodName:</code> and then define the method using the SQL code beneath until it hits end <code>; </code>.</li></ol></li></ol><p>Now we have some SQL code defined in a  <code>.sq</code>-file, how do we actually use this from our Kotlin-code?
We build the project, while building the project the code is generated to our build project with the Kotlin-code. It&#x27;ll provide</p><ul><li>Data Classes (like structs / objects / case classes)</li><li>Queries for each table</li></ul><p>And on top of this you&#x27;ll have <em>full</em> typing, which is pretty damn awesome! Let&#x27;s take a look at how we&#x27;d use this from Kotlin.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// Not optimal code, should use injection or something in reality for the db.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val database = Database(driver)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val personQueries: PersonQueries = database.personQueries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">println(personQueries.selectAll().executeAsList())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Prints []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">personQueries.insert(name = \&quot;Bob\&quot;, birthday = Date(2010, 1, 10))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">println(personQueries.selectAll().executeAsList())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Prints [Person.Impl(\&quot;Bob\&quot;, Date(2010, 1, 10))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val person = Person(\&quot;Ronald McDonald\&quot;, Date(2020, 1, 5))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">personQueries.insertPerson(person)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">println(personQueries.selectAll().executeAsList())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Prints [Person.Impl(\&quot;Bob\&quot;, Date(2010, 1, 10)), Person.Impl(\&quot;Ronald McDonald\&quot;, Date(2020, 1, 5))]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let me just say, I&#x27;m amazed about this kind of reverse thinking of generating code from SQL. It gives us the convenience of a ORM but the flexibility of raw SQL :happy:. </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="comparison-table">Comparison Table<a class="hash-link" href="#comparison-table" title="Direct link to heading">â€‹</a></h3><table><thead><tr><th>Database</th><th>Simplicity</th><th>Requires SQL knowledge</th><th>Configurability (complex queries etc)</th><th>Score (5)</th><th>Comment</th></tr></thead><tbody><tr><td>JDBC</td><td>I</td><td>III</td><td>III</td><td>2</td><td>To much overhead</td></tr><tr><td>Room / Slick</td><td>II</td><td>II</td><td>II</td><td>4</td><td>Strikes a good balance between natural in normal code while configurable*</td></tr><tr><td>Peewee</td><td>III</td><td>I</td><td>I</td><td>3</td><td>Really easy and fits into code great, but the complex queries becomes really hard and feels forced</td></tr><tr><td>SQLDelight</td><td>II</td><td>III</td><td>III</td><td>5</td><td>Natural to use in the code, great customability &amp; little overhead*</td></tr></tbody></table><p>Both Room &amp; SQLDelight are enforcing SQLite right now which is a major con for those that needs postgresql etc. Personally I only use SQLite as was discussed in <a href="https://blog.expensify.com/2018/01/08/scaling-sqlite-to-4m-qps-on-a-single-server/" target="_blank" rel="noopener noreferrer">expensify&#x27;s blog</a> SQLite can be squeezed to the extreme - expensify managed to handle up to 4 million queries per second!</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="outro">Outro<a class="hash-link" href="#outro" title="Direct link to heading">â€‹</a></h3><p>In its essence today there&#x27;s a great variety of different kinds of wrappers for databases in almost all languages and it is all about finding one that strikes your balance of perfect. For a really simple database perhaps an ORM such as <em>peewee</em> where no SQL knowledge is really required could be enough. But be sure to know the trade-offs, once your database grows complex so does peewee grow complex fast, same applies to slick and others. Raw SQL as a fall-back is always good to have and a lot of the libraries are starting to add it (e.g. slick), but it never feels natural and always is a bit like a bandaid, ugly right?</p><p>Anyhow, I hope this was interesting and perhaps someone learned about a new abstraction-level for databases or was inspired to pick up their own.</p><p>~Hampus</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/jvm">jvm</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kotlin">kotlin</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/db">db</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/multiplatform">multiplatform</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/londogard/londogard/blog/2020-06-01-sqldelight-kotlin.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/08/01/faq-search-covid-2"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">CoViD-19 FAQ Search Engine 2.0</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020/05/13/faq-search-covid-1"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">A simple FAQ search engine in Swedish using fastText &amp; Smooth Inverse Frequency</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-to-interact-with-a-sql-database-from-a-programming-language" class="table-of-contents__link toc-highlight">How to interact with a SQL Database from a programming language</a></li><li><a href="#moving-one-abstraction-level-up" class="table-of-contents__link toc-highlight">Moving one abstraction level up</a></li><li><a href="#moving-another-level-up-python--peewee" class="table-of-contents__link toc-highlight">Moving another level up (Python + Peewee)</a></li><li><a href="#sqldelight-abstraction-level-left-to-the-right" class="table-of-contents__link toc-highlight">SQLDelight: Abstraction level left to the right</a></li><li><a href="#comparison-table" class="table-of-contents__link toc-highlight">Comparison Table</a></li><li><a href="#outro" class="table-of-contents__link toc-highlight">Outro</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support Londogard</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/hlondogard" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/Lundez/button" title="Sponsor Lundez" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/londogard" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.londogard.com/blog/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/blog/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Londogard. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c03bf689.js"></script>
<script src="/assets/js/main.16001965.js"></script>
</body>
</html>