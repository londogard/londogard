<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Londogard Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Londogard Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-react-helmet="true">How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin) | Londogard Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.londogard.com/blog/2020/11/07/snake-kotlin-multiplatform"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="keywords" content="nlp, kotlin, jvm, deep-learning, machine-learning, blog"><meta data-react-helmet="true" property="og:title" content="How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin) | Londogard Blog"><meta data-react-helmet="true" name="description" content="A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform."><meta data-react-helmet="true" property="og:description" content="A three part blog (all included in this one) that goes through 1) How Kotlin Multiplatform works, 2) How to build a game (Snake) and finally 3) how to make it multiplatform."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-11-07T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/lundez"><meta data-react-helmet="true" property="article:tag" content="gradle,kotlin,workshop,multiplatform"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.londogard.com/blog/2020/11/07/snake-kotlin-multiplatform"><link data-react-helmet="true" rel="alternate" href="https://blog.londogard.com/blog/2020/11/07/snake-kotlin-multiplatform" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.londogard.com/blog/2020/11/07/snake-kotlin-multiplatform" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2b27dec1.css">
<link rel="preload" href="/assets/js/runtime~main.26debf92.js" as="script">
<link rel="preload" href="/assets/js/main.95872d60.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="Londogard logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/favicon.ico" alt="Londogard logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Londogard Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/blog/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/presentations">Presentations</a></div><div class="navbar__items navbar__items--right"><a href="https://londogard.com/about" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>About<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://londogard.com/projects" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Londogard Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/londogard" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/gpt2-snapsvisor">GPT2-snapsvisor - Generating Swedish Drinking Songs</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/timeseries-pt-3">Forecasting Crypto Prices using Deep Learning (Time Series #3)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/timeseries-pt-2">Predicting Stock Prices using classical machine Learning (Time Series #2)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/timeseries-pt-1">Decomposing &amp; Working with Time Series (Time Series #1)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kotlinjs-onnx-deep-learning-browser">KotlinJS, ONNX and Deep Learning in the browser</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">How to build and play Snake via Native Binary, JVM and JS/Browser (Kotlin)</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-11-07T00:00:00.000Z" itemprop="datePublished">November 7, 2020</time> ¬∑ <!-- -->25 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/lundez" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://github.com/lundez.png" alt="Hampus Lond√∂g√•rd"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lundez" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hampus Lond√∂g√•rd</span></a></div><small class="avatar__subtitle" itemprop="description">Main Contributor of Londogard</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>A three part blog (all included in this one) that goes through </p><ol><li>How Kotlin Multiplatform works (compiler and everything)</li><li>How to build a game (Snake) and finally </li><li>how to make it multiplatform.</li></ol><p><strong>All the code is available <a href="https://github.com/londogard/snake-js-jvm-native" target="_blank" rel="noopener noreferrer">here</a>.</strong></p><p>It&#x27;s highly recommended using IntelliJ, a free (community) edition can be downloaded from <a href="https://www.jetbrains.com/idea/download/#section=windows" target="_blank" rel="noopener noreferrer">jetbrains.com</a>.<br>
<!-- -->It&#x27;s also required that your Kotlin version is above 1.4 (some huge Multiplatform changes was added in release 1.4).</p><blockquote><p><strong>Disclaimer:</strong> this post is pretty long and I recommend reading one part at a time (it&#x27;s 3 parts).</p><p>Personally I hate unfinished blogs that are multiple parts, hence I uploaded all at once. So be assured, you&#x27;re getting all parts - right here, right now! :happy:</p><p>Finally, the first part is purely informational about how everything works and the second part is how to actually code the game. The second part is interactive and contains a lot of TODOs.
The third, and final, part covers how we are able to use the same code on JS/Browser &amp; Native</p></blockquote><p><strong>All the finished code is available <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project" target="_blank" rel="noopener noreferrer">here</a></strong> (open <code>master</code> if you wish to have the unfinished code).</p><h1>Introduction</h1><p>First off, what is Kotlin?</p><p><img src="https://lh6.googleusercontent.com/z07YTS2Ft_HypvBzChXpX4L1ye3y4ht0x142UCo8q6LGT0EaxZyEFA5hwP3_OV4ZQafkavgMBtRBP3X6RFPpogLTG5uR8J485-o6y1TOZ3xh_7TZkvTb7DOSGqIm5kiIZwPFCZdlLXg"></p><blockquote><p>Image from <a href="https://kotlinlang.org/" target="_blank" rel="noopener noreferrer">kotlinlang.org</a></p></blockquote><p>By my own account it&#x27;s a language that has learned from many mistakes done in the past and tries to extend and embrace the good ones!</p><p>The most obvious one solved by Kotlin is &quot;The Billion Dollar Mistake&quot; as the inventor <a href="https://en.wikipedia.org/wiki/Tony_Hoare" target="_blank" rel="noopener noreferrer">Tony Hoare</a> calls it himself, namely <code>null</code>. Kotlin is not alone about this, but certainly off to a good start!</p><p>Some mentionable features on top of this is</p><ul><li><a href="https://kotlinlang.org/docs/reference/coroutines-overview.html" target="_blank" rel="noopener noreferrer">Coroutines</a> - A more efficient (lightweight) threading model, also called &quot;green threads&quot; sometimes. Feels very natural and easy.</li><li><a href="https://kotlinlang.org/docs/reference/data-science-overview.html" target="_blank" rel="noopener noreferrer">Data-Science &amp; Jupyter</a> support</li><li><a href="https://kotlinlang.org/docs/reference/extensions.html#extensions" target="_blank" rel="noopener noreferrer">Extension functions</a> - Perhaps my favourite feature, do you feel a class is missing a function? No problem, you&#x27;re free to do so!</li><li>Excellent <a href="https://kotlinlang.org/spec/type-inference.html" target="_blank" rel="noopener noreferrer">typing</a> - Perhaps not Scala, but still very good.</li><li>&amp; more!</li></ul><p>All of this is available through Kotlins Multiplatform effort, where Multiplatform does not mean Mac/Windows/Linux but rather that we can compile into different platforms such as Java Bytecode (JVM), <a href="https://kotlinlang.org/docs/reference/native-overview.html" target="_blank" rel="noopener noreferrer">Native</a>  and <a href="https://kotlinlang.org/docs/reference/js-overview.html" target="_blank" rel="noopener noreferrer">JS/Browser</a>.</p><p>Enough praises, let&#x27;s get onto how the multiplatform solution actually works through <!-- -->[<strong>Part 1</strong>]<!-- -->(#Part 1: How does Kotlin Multiplatform work).</p><h1>Part 1: How does Kotlin Multiplatform work?</h1><p>Let&#x27;s begin by understanding exactly what <strong>Native</strong> is?
From the landing page of <a href="https://kotlinlang.org/docs/reference/native-overview.html" target="_blank" rel="noopener noreferrer">kotlinlang.org/native</a>.</p><blockquote><p>Kotlin/Native is a technology for compiling Kotlin code to native binaries, which can run without a virtual machine. It is an  <a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a>  based backend for the Kotlin compiler and native implementation of the Kotlin standard library.</p></blockquote><p>This statement tells us a few things, such as <em>native</em> refering to binary executables that can run on a OS (natively) using no virtual machine or browser!<br>
<!-- -->But in practice?</p><p>‚úîÔ∏è Small file size<br>
<!-- -->‚úîÔ∏è No overhead<br>
<!-- -->‚úîÔ∏è Incredibly fast starting-time</p><p>As usual it isn&#x27;t a win-win situation but you loose some</p><p>‚ùåDevelopment speed    </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="llvm">LLVM<a class="hash-link" href="#llvm" title="Direct link to heading">‚Äã</a></h2><p>LLVM is probably the biggest project (compiler) that exists to build native binaries. Languages such as C, C++, Haskell, Rust &amp; Swift compile into native binaries through LLVM.</p><p>From the info-box previously,</p><blockquote><p><strong>It is an  <a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a>  based backend for the Kotlin compiler</strong> and native implementation of the Kotlin standard library.</p></blockquote><p>So... What is a backend? More specifically, what is a backend for a compiler?</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-the-kotlin-compiler-works-frontend-to-backend">How the Kotlin Compiler works, Frontend to Backend<a class="hash-link" href="#how-the-kotlin-compiler-works-frontend-to-backend" title="Direct link to heading">‚Äã</a></h2><p>A compiler is like a translator, just as you&#x27;d translate Swedish into English a compiler instead translates computer code written in one programming language into another one of lower level, e.g. assembly. </p><p>In general all compilers follow the same pattern, and Kotlin is no different. Even though it&#x27;s a similar path it&#x27;s interesting to learn about, even more if you don&#x27;t know how it usually works!<br>
<!-- -->The Kotlin Compiler first compiles Kotlin code into a <em>Intermediate Representation</em>, or <em>IR</em>, which it later turns into Java Bytecode, when targeting the <em>Java Virtual Machine</em> (<em>JVM</em>). </p><p><img src="https://user-images.githubusercontent.com/7490199/97027300-d2095900-155a-11eb-9d18-6fb58a0a9699.png" alt="image"></p><p>The first part is called the <strong>Compiler Frontend</strong> </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-kotlin-compiler-frontend">The Kotlin Compiler Frontend<a class="hash-link" href="#the-kotlin-compiler-frontend" title="Direct link to heading">‚Äã</a></h3><p><img src="https://user-images.githubusercontent.com/7490199/97027463-1137aa00-155b-11eb-9c31-a60e3e25af87.png" alt="image"></p><p>The <em>Compiler Frontend</em> turns the Kotlin code into a <em>Intermediate Representation</em> of the code which is represented by a <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">abstract syntax tree</a>. The <em>abstract syntax tree</em> in turn is built from concrete syntax, e.g. strings.<br>
<!-- -->The process involves <a href="https://en.wikipedia.org/wiki/Lexical_analysis" target="_blank" rel="noopener noreferrer">lexical analysis</a> which creates tokens and pass it forward to the <a href="https://en.wikipedia.org/wiki/Parsing" target="_blank" rel="noopener noreferrer">parser</a> that finally builds the <em>abstract syntax tree</em>.<br>
<!-- -->For those interested this could be a really fun challenge and learning lesson to implement yourself!</p><p>Moving on, the second and final part is called the <strong>Compiler Backend</strong>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-kotlin-compiler-backend">The Kotlin Compiler Backend<a class="hash-link" href="#the-kotlin-compiler-backend" title="Direct link to heading">‚Äã</a></h3><p><img src="https://user-images.githubusercontent.com/7490199/97077672-ddee2d00-15e5-11eb-9f71-916c5b2a0544.png" alt="image"></p><p>The <em>Compiler Backend</em> turns this abstract syntax tree, or <em>IR</em>, into computer output language.<br>
<!-- -->In the image that is Java Bytecode which is understood by the <em>JVM</em>. The backend is the part that actually optimize code to remove for-loops where applicable, exchange variables into constants and so on.<br>
<!-- -->Just as with the frontend it&#x27;s a really good challenge to either implement a backend without optimizations, or focus on a existing one and adding a optimization yourself!</p><p>What is interesting about Kotlin is that it has different compiler backends, which means that the <em>IR</em> compile not only into Java Bytecode but also JS/Browser &amp; Native binaries. </p><p><img src="https://user-images.githubusercontent.com/7490199/97077776-b8155800-15e6-11eb-8ae6-a83a77253087.png" alt="image"></p><blockquote><p><strong>Side-note</strong>: For Native Backend there&#x27;s in fact two <em>Intermediate Representations</em>, first Kotlin <em>IR</em> which then compiles into LLVM <em>IR</em>. LLVM finally turns this into a native binary through its own Compiler Backend.<br>
<!-- -->During the final step in LLVM all the optimizations applied to C, C++, Swift &amp; many more is also applied to Kotlin Native code!</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-kotlin-keeps-multiplatform-clean">How Kotlin keeps multiplatform clean<a class="hash-link" href="#how-kotlin-keeps-multiplatform-clean" title="Direct link to heading">‚Äã</a></h2><p>It might sound messy to target multiple platforms like this, and how could it possibly end up clean?</p><p>By using the standard libraries that are included with Kotlin, which includes almost everything you need, and multiplatform-developed community libraries, e.g. <a href="https://github.com/cashapp/sqldelight" target="_blank" rel="noopener noreferrer">SQLDelight</a>, you get code that looks the same and works the same irregardless of target (JS/Browser, Native or the JVM).</p><p>To give an example of how Kotlin std-lib works, let&#x27;s take one of the most common types - <code>String</code>. </p><p><img src="https://user-images.githubusercontent.com/7490199/97077938-2dcdf380-15e8-11eb-8282-873d80f6178e.png" alt="image"></p><p>By using <code>Kotlin.String</code> rather than the usual <code>Java.lang.String</code> you do when programming Java you get a type that works on multiple platforms, including some awesome convenience functions. Imagine, you can write native code using <code>.substring</code>, <code>.take(n)</code> &amp; <code>.replace</code> - amazing compared to <code>c</code> right? :happy:</p><p>To put this in context of the compiler, this means that the <em>Compiler Backend</em> automatically maps the <em>IR</em> of a <code>Kotlin.String</code> into the correct type.</p><p>You can take this concept and apply to anything such as IO , network &amp; more - all which are included in the std-lib! </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summarizing-how-multiplatform-works">Summarizing how Multiplatform works<a class="hash-link" href="#summarizing-how-multiplatform-works" title="Direct link to heading">‚Äã</a></h2><p>Let&#x27;s recollect what we&#x27;ve gone through</p><ol><li>Kotlin Compiler compiles Kotlin code into a <em>Intermediate Representation</em> (IR) through the <em>Compiler Frontend</em>.<ol><li><em>IR</em> is a abstract syntax tree.</li></ol></li><li>Kotlin Compiler then goes the <em>Compiler Backend</em> which turns the code into the lower level language, e.g. Java Bytecode, and applies multiple optimisations.</li><li>Kotlin has a std-lib which has functionalities as <code>Kotlin.String</code>, <code>Kotlin.List</code>, networking and much more.<ol><li><code>Kotlin.String</code> turns into <code>KString</code> in the case of targeting <em>Native</em>. <code>KString</code> is Kotlins own native strings with some cool helper methods.</li></ol></li></ol><p>Native is usually considered &quot;dangerous&quot; and &quot;hard&quot; because of all the quirks like pointers, address space and other.</p><p>Kotlin Native deals with <em>memory allocation</em> in the same way as Swift, namely <a href="https://en.wikipedia.org/wiki/Reference_counting" target="_blank" rel="noopener noreferrer"><em>reference counting</em></a> which deallocates objects once they&#x27;ve got no references. There&#x27;s some advantages such as being really fast, but also downsides such as <em>reference cycles</em> which it handles poorly when compared to the JVM Garbace Collector (GC).</p><p>Kotlin also has some really nice convenience syntax such as the <code>memScope</code>-block.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="outro-kotlin-multiplatform-and-why-it-matters">Outro: Kotlin Multiplatform and why it matters<a class="hash-link" href="#outro-kotlin-multiplatform-and-why-it-matters" title="Direct link to heading">‚Äã</a></h2><p>‚úîÔ∏è One code-base for common logic  </p><ul><li>Serialization logic, e.g. parsing JSON into a data class</li><li>Networking</li><li>Database  </li></ul><p>‚úîÔ∏è Development speed<br>
<!-- -->‚úîÔ∏è Required Knowledge  </p><p>‚ùå Still requires some code in said language  </p><ul><li>Especially for UI</li></ul><p>So all in all we can share our code between platforms which improves development speed &amp; quality in multiple ways.</p><p>The biggest &quot;downside&quot; is that even though we share the code we most likely will need some kind of specific code for the platform, for the GUI on iOS as an example. Perhaps <a href="https://www.jetbrains.com/lp/compose/" target="_blank" rel="noopener noreferrer">compose</a> can help us get closer to that reality soon - who knows.<br>
<!-- -->The final, and perhaps obvious, one I&#x27;d like to mention straight away is that platform specific libraries of course are not usable on multiplatform. This includes libraries such as React (JS) &amp; <code>ncurses</code> (native).</p><p>Personally I see Kotlin Multiplatform as a great way to <strong>share core logic</strong> between different targets, but one must use it with care and <strong>not try to force it</strong> into being used everywhere in every way.</p><h1>Part 2: How to set up Multiplatform and build Snake</h1><blockquote><p><strong>OBS:</strong> Make sure to have Kotlin 1.4 or higher before starting the project. You can verify version &amp; update through File &gt; Settings &gt; Languages &amp; Frameworks &gt; Kotlin. There you see &quot;current version&quot; and if a newer one is available, make sure it&#x27;s at least 1.4 (any higher will work too)!</p></blockquote><p>First we&#x27;ll have to set up a Multiplatform project. The <a href="https://kotlinlang.org/docs/reference/mpp-create-lib.html" target="_blank" rel="noopener noreferrer">official guide</a> is actually really good, and if you&#x27;re using IntelliJ it&#x27;s a breeze to setup! Just as in the guide make sure to select <code>Library</code>.<br>
<strong>OBS:</strong> For each target (JVM, JS &amp; Native) select &quot;Template&quot; and choose Application for each.</p><p><img src="https://kotlinlang.org/assets/images/reference/mpp/mpp-project-1.png" alt="Select a project template"></p><p>Run the build.</p><blockquote><p><strong>Side-note:</strong> <code>gradle</code> is a really good build-tool that I&#x27;d like to discuss more. But for now let&#x27;s just enjoy the simplicity of how our whole project &#x27;automagically&#x27; just works and builds as expected while targeting different platforms.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-a-jvm-app-snake">Building a JVM App (Snake)<a class="hash-link" href="#building-a-jvm-app-snake" title="Direct link to heading">‚Äã</a></h2><p>Let&#x27;s start simple, Keep It Simple Stupid (KISS) principle applied, and create a JVM app. JVM has multiple advantages while developing such as</p><ol><li>Easy to run on all OS:es</li><li><em>Great</em> debugging!</li><li>A ton of resources</li></ol><p>First off, we need to draw something. This is easiest done through the Swing library which is included in the default jdk, some might call it old but hey - it does the job.Create a file called <code>main.kt</code> in <code>src/jvmMain/kotlin</code>.</p><p>Swing has a built-in threading solution (almost too bad, because <code>Coroutines</code> are awesome in Kotlin!) and the best way to start the GUI is by using the existing  <code>EventQueue</code> class and its <code>invokeLater</code> function. <code>invokeLater</code> makes sure the code runs last in the <code>EventQueue</code> if you add more methods, which makes sense - you want to draw the UI as the final thing.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EventQueue.invokeLater {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JFrame().apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title = &quot;Snake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            isVisible = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Where the <code>apply</code> is a context wrapper that takes the object and uses it as context (<code>this</code>) inside of the block/scope (<code>{}</code>). See its signature:</p><p><code>inline fun &lt;T&gt; T.apply(block: T.() -&gt; Unit): T</code></p><p>This would equate to </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val jframe = JFrame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jframe.title = &quot;Snake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jframe.isVisible = true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>in more Java-like syntax. Why use <code>apply</code>? It allows us to achieve some interesting chaining concepts which I really enjoy.</p><p>Now run the <code>main</code>-function, there should be a green &quot;run&quot;-button at the left, press that. Hopefully it compiles and a window will appear, with the title set to &quot;Snake&quot;.</p><p>Awesome! We need to render something inside of the box, a game soon enough, let&#x27;s see how we can achieve that.</p><p>Adding some minor refactoring and some new classes we can draw something</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Board: JPanel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TODO(&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Set background to black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Allow focus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Set preferredSize to some 200x300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class GUI: JFrame() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title = &quot;Snake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isVisible = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isResizable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setLocationRelativeTo(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultCloseOperation = EXIT_ON_CLOSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TODO(&quot;Add the Board to the JFrame, through add()&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EventQueue.invokeLater {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GUI()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>What are we doing?<br>
<code>JFrame</code> was refactored <code>GUI</code> which then is a subclass of <code>JFrame</code>, with a few extra attributes added such as <code>defaultCloseOperation = EXIT_ON_CLOSE</code> that makes sure the program exits if we close the window, feel free to test it out!<br>
<!-- -->Further a <code>Board</code> was added which extends <code>JPanel</code>, it&#x27;s in the <code>Board</code> the game will be rendered.<br>
<!-- -->Finally, <code>add(Board())</code> allows us to add our <code>Board</code>  to the <code>JFrame</code>.</p><p>Run!<br>
<!-- -->Something is not right.. The background seems black enough, but the size is most likely not correct. We can&#x27;t even resize as <code>isResizable=false</code> was set.<br>
<!-- -->Make sure to add <code>pack()</code> at the end, as in</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class GUI: JFrame() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        { /** same code as before */ }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add(Board())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pack()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>What <code>pack()</code> does is that it packs and resizes the <code>JFrame</code> to include all its component(s) and their current size(s).</p><p>Super! We&#x27;re now able to render our <code>Board</code> and see the whole board.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="drawing-the-snake--apple">Drawing the snake &amp; apple<a class="hash-link" href="#drawing-the-snake--apple" title="Direct link to heading">‚Äã</a></h3><p>We&#x27;ve got the canvas (Board), now we just need to get artsy and add a Snake and some Apples!<br>
<!-- -->I&#x27;ll keep it simple and will make the Board exist of a few cells, all pretty large. On each cell you either have nothing, Snake or Apple - pretty simple right?<br>
<code>JPanel</code> has some nice-to-have methods built-in, such as <code>repaint()</code> which simply repaints the component, which in turns calls <code>paintComponent(g: Graphics?)</code> to paint/render it.</p><blockquote><p><em>Disclaimer:</em>  the code might not be the most idiomatic, but I try to introduce a few concepts.</p></blockquote><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Board: JPanel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init { /** same code as before */ }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun paintComponent(g: Graphics?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.paintComponent(g)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val g2d: Graphics2D = g as? Graphics2D ?: return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.scale(20.0, 20.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.color = Color.GREEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.fill(Rectangle(5, 6, 1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.fill(Rectangle(5, 7, 1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.fill(Rectangle(5, 8, 1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Once again, let&#x27;s dive into what&#x27;s happening &#x27;under the hood&#x27;.  </p><p>First, we override the function <code>paintComponent</code> which renders <code>Board</code> layout. The input is a <strong>nullable <code>Graphics</code></strong>, which is shown by the type having a <code>?</code> at the end. This is a cool property of Kotlin, if something can be <code>null</code> it actually is a type. No <code>Option</code>/<code>Maybe</code>, just pure type.  </p><p>Then <code>Graphics?</code> is cast to non-null <code>Graphics2D</code> through a safe approach using <code>as?</code>, without <code>?</code> the cast can crash, with <code>?</code> the cast would return <code>null</code> if failing.  </p><p>Finally we use a <strong>elvis-expression <code>?:</code></strong> which is basically a wrapper for <code>if (null) doThis else doThat</code>, so if the left-hand-side is <code>null</code> it&#x27;ll give the right-hand-side. The right-hand-side in our case is a empty <code>return</code> statement, meaning that we just make a early-exit. If the value is <em>not</em> <code>null</code> it&#x27;ll give the non-null variant of the type! </p><blockquote><p>Example use-case of elvis-operator <code>?:</code><br>
<code>val a: Int = 1 ?: 0 // a = 1</code><br>
<code>val b: Int = null ?: 0 // b = 0</code> </p></blockquote><p>Detailing the code further we now have <code>g2d: Graphics2D</code> where <code>Graphics2D</code> which gives us a few nice functions to draw components on the <code>Board</code>. </p><ul><li>We set the scale to 20<ul><li>This simplifies the behaviour, we can now use 20x30 grid where each cell is size 1, but it&#x27;s scaled into the 200x300 grid.</li></ul></li><li>We use <code>fill</code> to draw <code>Rectangle</code>&#x27;s with set <code>Color</code>.</li></ul><blockquote><p><strong>Side-note:</strong>
For those wondering how you safely execute on <code>null</code>s by chaining, like you do with Monads (<code>Option</code>)</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val nullableGraphics: Graphics? = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nullableGraphics?.scale(20.0, 20.0) // This is safe! No operation executed if null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></blockquote><p>Summing up, we now know how to render stuff on the <code>Board</code> and it&#x27;s all very static.<br>
<!-- -->The next step is to make the rendering less static and I believe the natural step from now is to create the data structures that&#x27;ll contain the game &amp; its state. Then we can make sure the data structures are able to update, so we can render new states.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="creating-the-data-structures">Creating the data structures<a class="hash-link" href="#creating-the-data-structures" title="Direct link to heading">‚Äã</a></h3><p>Data structures are required to have a game state, that is the score and position of everything. </p><p>The natural state is <code>Game</code> which contains everything, let&#x27;s begin by creating a <code>Game</code> structure which contains the size of the <code>Board</code>.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data class Game(val width: Int, val height: Int)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p><strong>Side-note:</strong> A <code>data class</code> is essentially the same as a  <code>case class</code> from Scala. And for those who don&#x27;t know what a <code>case class</code> is it&#x27;s basically a <code>class</code> that simplifies a lot of stuff, mainly used as a data structure.<br>
<!-- -->You get <code>equals</code>, getters &amp; setters, and much more for free.<br>
<!-- -->Anyone from Java knows how awesome this is.</p></blockquote><p>Moving on we need to define the cells mentioned, something like</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data class Cell(val x: Int, val y: Int)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Wrapping up our current state we got most of what we need, <code>Game</code> which contains our game state &amp; <code>Cell</code> which is our co-ordinates.<br>
<!-- -->The next step is to actually draw the <code>Cell</code>&#x27;s and wrap the <code>Cell</code> in other classes such as <code>Apple</code> and <code>Snake</code>.  </p><p>Let&#x27;s add all the required code.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data class Apples(val cells: Set&lt;Cell&gt; = emptySet())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data class Snake(val cells: List&lt;Cell&gt;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val head: Cell = TODO(&quot;Take the first cell.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val tail: List&lt;Cell&gt; = TODO(&quot;Drop one cell and return the rest.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data class Game(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val width: Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val height: Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val snake: Snake,   // Adding snake and apples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val apples: Apples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Board: JPanel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private val game: Game = Game(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        20,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        30,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Snake(listOf(Cell(2,3),Cell(2,4),Cell(2,5),)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Apples(setOf(Cell(4,5)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        background = Color.black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isFocusable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preferredSize = Dimension(200, 300)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun paintComponent(g: Graphics?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.paintComponent(g)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val g2d = g as? Graphics2D ?: return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.scale(20.0, 20.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g2d.color = Color.GREEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        game.snake.tail.forEach { cell -&gt; TODO(&quot;Render the cells using the previously used technique&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TODO(&quot;Render the head using the color YELLOW&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TODO(&quot;Render the apples using the color RED&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Fixing the added <code>TODO</code>s and keeping the same <code>GUI</code> &amp; <code>fun main</code> we can now run the code. You should be seeing something like </p><p><img src="https://user-images.githubusercontent.com/7490199/97808473-5c427300-1c67-11eb-9fa9-9110f596533b.png" alt="image"></p><p>Pretty cool right!? We&#x27;ve got<br>
<!-- -->‚úîÔ∏è Rendering<br>
<!-- -->‚úîÔ∏è Data Structures</p><p>What&#x27;s left?</p><ol><li>A game loop</li><li>Ability to actually move the data structures ( <code>Snake</code>)</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="adding-a-direction">Adding a Direction<a class="hash-link" href="#adding-a-direction" title="Direct link to heading">‚Äã</a></h4><p>To be able to move we need to know what directions to move in. In my humble opinion this is simplest done through a <code>Enum</code>.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enum class Direction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DOWN,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LEFT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RIGHT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Simple enough. But let&#x27;s make it better, even though pre-optimization is the root of all evil it is sometimes fun üòÄ.<br>
<!-- -->Enums in Kotlin are pretty awesome, they can both keep values and have methods! Let&#x27;s add <code>dx</code> and <code>dy</code>.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enum class Direction(val dx: Int, val dy: Int) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UP(0, -1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DOWN(0, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LEFT(-1, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RIGHT(1, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Through <code>dx</code> and <code>dy</code> we can add it to the current cell to move in the direction which <code>Direction</code> is!</p><p>Updating <code>Snake.kt</code> &amp; <code>Cell.kt</code> to have <code>Cell</code> with <code>Direction</code> and some <code>turn</code>.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data class Cell(val x: Int, val y: Int) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun move(direction: Direction) = TODO(&quot;Create new cell which moves in direction. OBS: Remember Direction now has dx, dy!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data class Snake(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val cells: List&lt;Cell&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val direction: Direction, // new attribute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val eatenApples: Int = 0 // new attribute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun move(): Snake {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val newHead = TODO(&quot;Move head&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val newTail = TODO(&quot;Move tail!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return TODO(&quot;Create a new Snake with the updated position!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun turn(newDirection: Direction?) = TODO(&quot;Make sure to turn correctly&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is all fine &amp; dandy, but there is some improvements to be made that&#x27;ll clean up the code.<br>
<!-- -->I mentioned that Kotlin <code>Enums</code> can have methods, which is awesome. We can simplify the <code>turn</code>-logic by adding a method to <code>Direction</code>, namely <code>isOppositeTo</code>. See the code below.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enum class Direction(val dx: Int, val dy: Int) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** Same code as previously */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun isOppositeTo(that: Direction) =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dx + that.dx == 0 &amp;&amp; dy + that.dy == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Right, we can now turn the snake and render the game. We need the <code>Game</code>-state to update to actually re-render the updated Snake, let&#x27;s add a <code>update</code>-function that does this.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun update(direction: Direction?): Game {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return TODO(&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Make sure to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        1. Turn snake in direction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2. Move</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        3. Update the game state by returning Game</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And our GUI</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Board: JPanel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var dir: Direction = Direction.RIGHT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var game: Game = Game(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        20,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        30,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Snake(listOf(Cell(2,3),Cell(2,4),Cell(2,5),), dir),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Apples(setOf(Cell(4,5)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addKeyListener(object : KeyAdapter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            override fun keyPressed(e: KeyEvent?) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dir = when (e?.keyCode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    VK_I, VK_UP, VK_W -&gt; Direction.UP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else -&gt; TODO(&quot;Add the other key bindings. Reflect of how the object works and what is happening.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                game = game.update(dir)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                repaint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In our <code>init</code> (equal to a constructor) we add a <code>keyListener</code> which will listen on whenever we move. We moved <code>game</code> to be a <code>var</code> which allows us to change the reference.</p><blockquote><p><strong>Side-note:</strong> The difference between a <code>val</code> and <code>var</code> is not about immutability of the value, but rather that you cannot change the pointer to the object. By using <code>val</code> the compiler don&#x27;t allow you to change the reference.  </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val a = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a = 3 // CRASH -- This is not allowed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var b = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b = 3 // b = 3, this is allowed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Please note that this means that if your object is mutable, you can mutate the state of the object even though it&#x27;s a <code>val</code>.</p></blockquote><p>Why put <code>game</code> on a <code>var</code> you might ask? Otherwise how would we update our <code>Game</code> as the data structure itself is &quot;immutable&quot;, i.e. cannot be changed, which would mean that we&#x27;d need to add a new <code>Game</code> object each time and save it on the stack (never cleaning it up) and that&#x27;d pretty fast make the application crash because of <code>out of memory</code>.</p><p>Finally, we update the game by calling our created <code>update</code>-method and then we use <code>repaint()</code> which draws the components!</p><blockquote><p><strong>Remember:</strong> <code>paintComponent</code> draws the canvas (game), so whenever <code>repaint</code> is called <code>paintComponent</code> draws the game again based on the <code>game</code> and <code>cell</code>&#x27;s in the game.</p></blockquote><p>In conclusion this gives us an incredibly simple game, the snake moves whenever we press a key as we <em>still don&#x27;t have a game loop</em> based on time. So how do we add a game loop based on time?</p><p>The JVM got you covered! In the <code>keyListener</code> remove the update &amp; repaint, then add a <code>timer </code> </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fixedRateTimer(TODO(&quot;Explore options to use for the timer and how they work&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TODO(&quot;Insert a game loop here, essentially the same as done in the keyListener previously!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the game! ...amazing right?  </p><p>We now move our snake, and it moves by itself if we don&#x27;t.
But the game is still pretty boring... We never die, no apples can be eaten and finally no new apples appear. We have a few additions to make to make the game a bit challenging..</p><p>Let&#x27;s start by fixing the apples. Update the <code>Apples.kt</code> to randomly add apples to the board when calling <code>grow()</code>.</p><blockquote><p>To simplify the logic we use a <code>set</code> which means that all apples added are unique.</p></blockquote><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data class Apples(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val width: Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val height: Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val cells: Set&lt;Cell&gt; = emptySet(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val growthSpeed: Int = 3, // this could actually be to only spawn apple when there is no other apple. Up to user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val random: Random = Random // Once again, Kotlin provides a superb class, in this case a Random wrapper that works on JVM, JS &amp; Native - cool right?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun grow(): Apples {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return TODO(&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        If we have a random number greater than growthSpeed, return no update. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Otherwise add a new cell.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then we should allow the Snake to eat them, make sure to add <code>eat(apples: Apples)</code> method and implement it for <code>Snake.kt</code>.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun eat(apples: Apples): Pair&lt;Snake, Apples&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return TODO(&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If our head is on a Apple location, return a pair of Snake and Apple untouched.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Otherwise make sure to remove the apple from apples and increase body size of snake!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>At the end of all this we need the <code>Game.kt</code> to allow this logic to be used. This is done through updating <code>update</code> to allow the snake to <code>eat</code> apples and also <code>grow</code> apples to add new ones.</p><p>Great! We can eat apples, add new apples and all. But we&#x27;re still pretty invincible and we&#x27;ll just keep going forever.
We need to make sure that the end can be lost, let&#x27;s do it by adding a new attribute <code>isOver</code> to <code>Game.kt</code></p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val score: Int = TODO(&quot;Score based on snakes size, e.g. cell size&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val isOver: Boolean = TODO(&quot;Game is over if snake head in tail or snake head not on the map!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun update(dir: Direction): Game {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isOver) return this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { /** same code as was here before */ }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="wrapping-up-the-code-with-some-minor-refactoring--new-functionality">Wrapping up the code with some minor refactoring / new functionality<a class="hash-link" href="#wrapping-up-the-code-with-some-minor-refactoring--new-functionality" title="Direct link to heading">‚Äã</a></h2><p>Kotlin has a wonderful concept of <strong>extension functions</strong>, which simply is incredible. An extension function extends a class with new functionality. Did you ever wish <code>Double</code> had a rounding to string? <code>fun Double.roundTo(n: Int): String = &quot;%.${decimals}f&quot;.format(this)</code> solves this for you! Now your <code>Double</code>&#x27;s automatically gives you a hint to use <code>.roundTo</code> as one of <code>Double</code>&#x27;s built-in functions!</p><p>With these we can update our main-method to be a tiny bit cleaner.</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">g2d.color = Color.GREEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">game.snake.tail.forEach { cell -&gt; g2d.fill(Rectangle(cell.x, cell.y, 1, 1)) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Turns into --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fun Graphics2D.renderCells(color: Color, cells: Iterable&lt;Cell&gt;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.color = color</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cells.forEach { cell -&gt; fill(Rectangle(cell.x, cell.y, 1, 1)) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Which allows us to just call `g2d.renderCells(Color.GREEN, game.snake.tail)` etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>What more improvements can be made?</strong></p><p>Exercises left for the reader:</p><ol><li>Add Score on the loosing screen</li><li>Add a win-condition (basically impossible, but taking all apples)</li><li>Reinforcement learning to train a bot (might be a future blog!)</li><li>Better &amp; cleaner code!</li></ol><h1>Part 3: True multiplatform (moving to JS &amp; Native)</h1><p>I&#x27;ll begin by saying that this part is more of a reader exercise. If you want the finished code please go to the <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project" target="_blank" rel="noopener noreferrer">GitHub repository</a>.<br>
<!-- -->The idea is that this part will be solved by yourself during the workshop this is intended for.</p><p>All the snake-related code that isn&#x27;t in your <code>main.kt</code>-file should be moved into <code>src/commonMain/kotlin</code> which makes it <strong>multiplatform</strong>-code. This means that it can target JS, Native &amp; JVM instantly! </p><blockquote><p><strong>Side-note:</strong> because all the functionality for the Data Structures (e.g. <code>take</code>, <code>List</code>, <code>Random</code>) exists in Kotlin std-lib it&#x27;s automatically possible to use in multiplatform.</p></blockquote><p>This is not true all the time, if we use platform-specific code. Our platform-specific code, tied with the JVM, is the <code>timer</code> and <code>Swing</code> which means that our whole GUI is tied to the JVM. </p><p>When the code has been migrated and import-paths are updated, run the JVM app again and validate that everything works.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="jsbrowser-target">JS/Browser target<a class="hash-link" href="#jsbrowser-target" title="Direct link to heading">‚Äã</a></h2><p>Now create <code>src/jsMain/kotlin/main.kt</code>.</p><p>In this file we need to define how to draw the browser-based GUI. Some key methods, for the full code check out the git repository.</p><p><strong>KeyListener</strong>
<code>document.onkeydown = { event -&gt; onkeydown(event).also { keyDir -&gt; dir = keyDir } }</code> where <code>onkeydown</code> is your own method that handles key-events.</p><p><strong>Timer</strong>
<code>window.setInterval({ game = game.update(dir); render(canvas, game) }, 200)</code></p><p><strong>Canvas</strong>  </p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">val canvas = document.getElementById(&quot;snake-canvas&quot;) as HTMLCanvasElement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val ctx = canvas.getContext(&quot;2d&quot;) as CanvasRenderingContext2D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>On this <code>ctx</code> from the canvas you can use <code>fillRect</code> to draw rectangles, and <code>fillStyle</code> to set color.</p><p><strong>HTML-Canvas</strong><br>
<code>&lt;canvas id=&quot;snake-canvas&quot; width=&quot;400px&quot; height=&quot;300px&quot;&gt;&lt;/canvas&gt;</code> (put in <code>index.html</code>)</p><p>The game is run through <code>./gradlew jsBrowserRun</code>, or selecting the gradle-icon at the top right (elephant) and typing <code>jsBrowserRun</code>.</p><p>And the code for the GUI using these components is pretty much exactly the same as in Swing to be honest. </p><p>Congratulations, you have now achieved creating a desktop game and a browser game!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="native-target">Native target<a class="hash-link" href="#native-target" title="Direct link to heading">‚Äã</a></h2><p>And onto our final target, Native Binary, that runs completely without a browser or a virtual machine.</p><p>For the Native target the GUI will be supported through the library <code>ncurses</code> which unfortunately is only supported on Linux &amp; MacOS. If you&#x27;ve windows you can solve this through <em>Windows Subsystem for Linux</em> (WSL).</p><p>Begin by creating <code>src/nativeMain/kotlin/main.kt</code>.</p><p>To begin, in the main-function do the following:</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun maint(): Unit = memScoped {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // insert code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <code>memScoped</code> part means that all memory allocated in the block is automatically disposed at the end, incredibly useful! :happy:</p><p>Then reading how to use <code>ncurses</code> we can figure out how to init this. The final end-goal being</p><div class="codeBlockContainer_I0IT language-kotlin theme-code-block"><div class="codeBlockContent_wNvx kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun main(): Unit = memScoped {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initscr()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defer { endwin() }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noecho()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curs_set(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    halfdelay(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var game: Game = TODO()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val window = newwin(game.height + 2, game.width + 2, 0, 0)!!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defer { delwin(window) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var input = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (input.toChar() != &#x27;q&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        window.draw(game)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input = wgetch(window)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val direction = when (input.toChar()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &#x27;i&#x27; -&gt; TODO(&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        game = game.update(direction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private fun CPointer&lt;WINDOW&gt;.draw(game: Game) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wclear(this)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    box(this, 0u, 0u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    game.apples.cells.forEach { mvwprintw(this, it.y + 1, it.x + 1, &quot;.&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    game.snake.tail.forEach { mvwprintw(this, it.y + 1, it.x + 1, &quot;o&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    game.snake.head.let { mvwprintw(this, it.y + 1, it.x + 1, &quot;Q&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (game.isOver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mvwprintw(this, 0, 6, &quot;Game Over&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mvwprintw(this, 1, 3, &quot;Your score is ${game.score}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wrefresh(this)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Try running it in the terminal.</p><p>This blog was created as a companion to a workshop I&#x27;m gonna do at AFRY, it has a bit more content including a presentation in person.</p><p>All the finished code is available <a href="https://github.com/londogard/snake-js-jvm-native/tree/completed_project" target="_blank" rel="noopener noreferrer">here</a>, if you prefer the unfinished code head to <a href="https://github.com/londogard/snake-js-jvm-native" target="_blank" rel="noopener noreferrer">master-branch</a>.</p><p>Thanks!</p><p>~Hampus</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/gradle">gradle</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kotlin">kotlin</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/workshop">workshop</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/multiplatform">multiplatform</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/londogard/londogard/blog/2020-11-07-snake-kotlin-multiplatform.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/12/12/transfer-learning-presentation"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Transfer Learning (Presentation)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020/09/04/til-sdkman"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">TIL: SDKMan - The Software Development Kit Manager</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#llvm" class="table-of-contents__link toc-highlight">LLVM</a></li><li><a href="#how-the-kotlin-compiler-works-frontend-to-backend" class="table-of-contents__link toc-highlight">How the Kotlin Compiler works, Frontend to Backend</a><ul><li><a href="#the-kotlin-compiler-frontend" class="table-of-contents__link toc-highlight">The Kotlin Compiler Frontend</a></li><li><a href="#the-kotlin-compiler-backend" class="table-of-contents__link toc-highlight">The Kotlin Compiler Backend</a></li></ul></li><li><a href="#how-kotlin-keeps-multiplatform-clean" class="table-of-contents__link toc-highlight">How Kotlin keeps multiplatform clean</a></li><li><a href="#summarizing-how-multiplatform-works" class="table-of-contents__link toc-highlight">Summarizing how Multiplatform works</a></li><li><a href="#outro-kotlin-multiplatform-and-why-it-matters" class="table-of-contents__link toc-highlight">Outro: Kotlin Multiplatform and why it matters</a></li><li><a href="#building-a-jvm-app-snake" class="table-of-contents__link toc-highlight">Building a JVM App (Snake)</a><ul><li><a href="#drawing-the-snake--apple" class="table-of-contents__link toc-highlight">Drawing the snake &amp; apple</a></li><li><a href="#creating-the-data-structures" class="table-of-contents__link toc-highlight">Creating the data structures</a></li></ul></li><li><a href="#wrapping-up-the-code-with-some-minor-refactoring--new-functionality" class="table-of-contents__link toc-highlight">Wrapping up the code with some minor refactoring / new functionality</a></li><li><a href="#jsbrowser-target" class="table-of-contents__link toc-highlight">JS/Browser target</a></li><li><a href="#native-target" class="table-of-contents__link toc-highlight">Native target</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support Londogard</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/hlondogard" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/Lundez/button" title="Sponsor Lundez" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/londogard" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.londogard.com/blog/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/blog/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Londogard. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.26debf92.js"></script>
<script src="/assets/js/main.95872d60.js"></script>
</body>
</html>