<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hampus Londögård">
<meta name="dcterms.date" content="2023-02-19">
<meta name="description" content="This is something all of us know but sometime forget, or ignore, when we learn about a new technology or methodology in a presentation/blog.">

<title>Londogard Blog - Best Practices Are Contextual</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Londogard Blog - Best Practices Are Contextual">
<meta name="twitter:description" content="This is something all of us know but sometime forget, or ignore, when we learn about a new technology or methodology in a presentation/blog.">
<meta name="twitter:image" content="https://blog.londogard.com/posts/assets/randomsubsampler.png">
<meta name="twitter:creator" content="@hlondogard">
<meta name="twitter:image-height" content="1803">
<meta name="twitter:image-width" content="1780">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Londogard Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pages/presentations.html" rel="" target="">
 <span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://londogard.com/projects" rel="" target="">
 <span class="menu-text">Londogard Projects↗</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pages/about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/code_setup/code_setup.html" rel="" target="">
 <span class="menu-text">Dev Setup</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hampus-londögård/" rel="" target=""><i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hlondogard" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/lundez" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Lundez</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/londogard" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Londogard</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml" rel="" target=""><i class="bi bi-rss" role="img" aria-label="Londogard Blog RSS">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Best Practices Are Contextual</h1>
                  <div>
        <div class="description">
          This is something all of us know but sometime forget, or ignore, when we learn about a new technology or methodology in a presentation/blog.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">soft</div>
                <div class="quarto-category">pipeline</div>
                <div class="quarto-category">deep-learning</div>
                <div class="quarto-category">data</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Hampus Londögård </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 19, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#problem-identification" id="toc-problem-identification" class="nav-link" data-scroll-target="#problem-identification">Problem Identification</a>
  <ul class="collapse">
  <li><a href="#step-1-dont-trust-environments" id="toc-step-1-dont-trust-environments" class="nav-link" data-scroll-target="#step-1-dont-trust-environments">Step 1: Don’t Trust Environments</a></li>
  <li><a href="#step-2-embrace-debuggers-profilers" id="toc-step-2-embrace-debuggers-profilers" class="nav-link" data-scroll-target="#step-2-embrace-debuggers-profilers">Step 2: Embrace Debuggers &amp; Profilers</a></li>
  </ul></li>
  <li><a href="#rethinking-our-pipeline" id="toc-rethinking-our-pipeline" class="nav-link" data-scroll-target="#rethinking-our-pipeline">Rethinking our pipeline</a>
  <ul class="collapse">
  <li><a href="#optimizing-preprocessing" id="toc-optimizing-preprocessing" class="nav-link" data-scroll-target="#optimizing-preprocessing">Optimizing Preprocessing&nbsp;</a></li>
  <li><a href="#optimizing-training-loop" id="toc-optimizing-training-loop" class="nav-link" data-scroll-target="#optimizing-training-loop">Optimizing Training Loop</a></li>
  </ul></li>
  <li><a href="#what-we-learned" id="toc-what-we-learned" class="nav-link" data-scroll-target="#what-we-learned">What we learned</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Today Best Practices are commonly presented as the <em>One True Solution™</em> without considering the context(s) in which the practice is to be applied. I believe that with todays frameworks &amp; methodologies it’s getting more and more common that people start following a kind of “hive-mind”, and who’s the driver? Usually the ones selling it…</p>
<p>Of course there’s multiple other angles such as:</p>
<ul>
<li>“No on ever got fired by buying IBM” (or following MANGA best practices)</li>
<li>Career Climbing
<ul>
<li>Who wouldn’t want to make their CV more interesting by applying a well-known technique or framework? Even if it doesn’t make sense for the application.</li>
</ul></li>
</ul>
<p>Anyhow, this is the story of how we/I got caught in a best practice which actually <em>didn’t apply</em> in my context. Ironically giving a new advice! 😅 Who knows, perhaps it’ll end up being a trap in the future.. 🤔</p>
<section id="background" class="level1">
<h1>Background</h1>
<p>We started a project where we had a lot of data, not Big Data, but a decent chunk of &gt; 100 GB.<br>
Being active in the industry and following the latest trends I knew that streaming data rather than loading it all makes a lot of sense and is recommended in multiple libraries such as <a href="https://huggingface.co/docs/datasets/index">HuggingFace Datasets</a>.</p>
<p>Further I knew that there’s certain file formats which works exceptionally when streaming, or <code>mmap</code>, to do a very cheap data load and usage.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>mmap</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Memory-mapping (<code>mmap</code>)&nbsp;is a solution to stream data into memory from disk, and back. This enables us to:</p>
<ol type="1">
<li>Transform a bigger-than-memory dataset and write to disk again.<br>
</li>
<li>Train on a bigger-than-memory dataset by streaming it into memory</li>
</ol>
</div>
</div>
<p>Using&nbsp;<code>mmap</code>&nbsp;combined with a good file format such as Apache Arrow is praised around by companies and libraries.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Apache Arrow
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://arrow.apache.org/">Apache Arrow</a> is a column-based file format which is saved in a deserialized format, i.e.&nbsp;it is the same as it is in-memory.</p>
<p>This results in incredibly efficient <code>mmap</code> where we can stream data into memory <em>without deserialize/serialize</em>! Further by being a OLAP (column-based) format you can slice the columns you use and not stream anything else. Exceptional!</p>
</div>
</div>
<p>I’ve first-hand experience of the gains of using OLAP-based file formats such as <code>parquet</code> which additionally supply column-compression which is very efficient in analytics. How many rows contain the same date repeated? Now it’s cheap! 😉</p>
<p>Based on my history of using&nbsp;<code>mmap</code>&nbsp;algorithmically (low-level) and OLAP files we ended up using&nbsp;<a href="https://huggingface.co/docs/datasets/index">🤗 Datasets</a>&nbsp;which is a library to work with datasets.&nbsp;</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🤗 (HuggingFace)
</div>
</div>
<div class="callout-body-container callout-body">
<p>HuggingFace&nbsp;is a company that helps other companies deploy State-of-the-Art text and image models while providing a huge Open Source community with a lot of datasets, models and much more.</p>
</div>
</div>
<p>Their dataset API must be based on best practise right? What we later learned is that best practice really is contextual.&nbsp;<strong>This is the story.</strong></p>
</section>
<section id="problem-identification" class="level1">
<h1>Problem Identification</h1>
<p>As a primer, <em>how do you even identify this type of issue?</em> After all it’s very easy to hide such problems by using powerful compute in the cloud.</p>
<p>The answer is rather simple, <em>if the training is equal fast using a CPU (M1) as GPU you’re thouroughly under-utilizing your GPU.</em></p>
<p>There’s multiple instances where one would never notice as a lot of practicioneers tend to run directly on a cloud compute, but if you found this to be true you’d surely pause and reflect on your task, right?</p>
<section id="step-1-dont-trust-environments" class="level2">
<h2 class="anchored" data-anchor-id="step-1-dont-trust-environments">Step 1: Don’t Trust Environments</h2>
<p>Don’t make your cloud compute solve all problems from the get-go, allow yourself to gradually move into the cloud by utilizing a <strong>Local-First approach</strong>. Allowing yourself to run locally just as easily as in the cloud opens a lot of possibilities such as:</p>
<ul>
<li>Quick iterations by running subset-training</li>
<li>Improved Circular Data Analysis</li>
<li>A certain satisfaction of simplicity</li>
</ul>
<p>I’ll write a blog on&nbsp;<em>Local First</em>-approach and all the bonuses of such workflow later.</p>
<p>As we started our journey to find problem(s) in our “best-practice” training pipeline we need to understand what is actually happening - introducing debuggers &amp; profilers!</p>
</section>
<section id="step-2-embrace-debuggers-profilers" class="level2">
<h2 class="anchored" data-anchor-id="step-2-embrace-debuggers-profilers">Step 2: Embrace Debuggers &amp; Profilers</h2>
<p>PyCharm and VS Code includes some great debuggers which allows us to step into functions and execute different logic to further understand what’s happening under the hood. Further there’s great tools to track what happens post-run which are called Profilers.</p>
<p>One such profiler is the&nbsp;<a href="https://pytorch.org/tutorials/recipes/recipes/profiler_recipe.html">PyTorch Profiler</a>&nbsp;that we embraced. Using a profiler we found that we spend <em>a lot of time</em> inside the DataLoader - which is not a good sign! We’d like to optimize GPU usage.</p>
<p>We built a hypothesis, the Macbook Pro M1 has a much faster SSD and because of that it trains equally fast as the Azure VM based on bottlenecking in the DataLoader. The I/O-operations being much faster leads to equal performance even if it has slower mathematical operations.</p>
<p>To make sure that Azure had a fair challenge we validated the following:</p>
<ul class="task-list">
<li><input type="checkbox" checked="">We’re&nbsp;<strong>not</strong>&nbsp;using a mounted storage but a downloaded dataset on the VM</li>
<li><input type="checkbox" checked="">We’re using the correct VM</li>
</ul>
<p>All seem correct, what else can we do to improve? 🤔</p>
<p>We decided to rethink our “best practice” pipeline. Where could we save time? What’s is actually the part of the DataLoader that’s slow?</p>
</section>
</section>
<section id="rethinking-our-pipeline" class="level1">
<h1>Rethinking our pipeline</h1>
<p>We found the biggest bottleneck pretty fast.</p>
<p><strong>🎯&nbsp;<em>Random Access Read</em></strong><br>
Random Access is slow with high latency even on the best SSD’s, and this is why&nbsp;<em>Random Access Memory</em>&nbsp;(RAM) exist! It has improved substantially the last decade, but nonetheless it’s slow.</p>
<p>We built a system that retrieves data from columnar storage but randomly. Our batches are sequential which helps a little, but we extract our batch starting point randomly, see <a href="#fig-subsamp">Figure&nbsp;1</a>. We’re solving a time series forecasting problem which also means we expand one data point into a window of the last X points to predict future Y points. This isn’t cheap either, to roll over data like this.<br>
To keep a batch internally intact is very important for some models such as the Recurrent Neural Networks (RNN) that keeps an internal state being reset each batch.</p>
<div id="fig-subsamp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="assets/randomsubsampler.png" height="300" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: RandomSubsequenceSampler that allows randomizing batches but keeping batches internally intact</figcaption>
</figure>
</div>
<p>This means that by keeping more data in-memory (RAM) we can reduce our latency and bottleneck! Especially on VM’s with slower SSD’s such as Azure.🦸‍♂️</p>
<p>With this realization decided to optimize our pipeline by sidestepping best-practice and building a simple but custom batch-operation.</p>
<section id="optimizing-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="optimizing-preprocessing">Optimizing Preprocessing&nbsp;</h3>
<p>As we applied one optimization after another it built into this beautiful onion where we by each layer we removed we had new opportunities based on the new base.</p>
<ol type="1">
<li>Preprocess by batch rather than streaming data (by batch)
<ul>
<li>One batch being one file</li>
</ul></li>
</ol>
<p>This sped up our preprocessing enough that we don’t need to cache it and thereby no need to do it on all data. This means that we could apply our second optimization.</p>
<ol start="2" type="1">
<li>Preprocess by a sliced batch, i.e.&nbsp;only columns used</li>
</ol>
<p>This sped up our pipeline and substantially reduced memory requirements leading us to our third and final optimization in pre-processing.</p>
<ol start="3" type="1">
<li>Scale the scalers on a sample of the data.</li>
</ol>
<p>All in all we had huge speedups in our preprocessing, as follows:</p>
<ol type="1">
<li>~ 10x faster</li>
<li>~ 10x faster</li>
<li>~ 2x faster</li>
</ol>
<p><strong>All in all our pipeline went from ~20 minutes to seconds!</strong></p>
</section>
<section id="optimizing-training-loop" class="level3">
<h3 class="anchored" data-anchor-id="optimizing-training-loop">Optimizing Training Loop</h3>
<p>With preprocessing completing in seconds rather than minutes we could move ahead to improve our training loop.&nbsp;</p>
<p>Based on our learnings from the preprocessing iterations we knew that we could essentially load all data into memory if we sliced it, which we usually did, resulting in only using 1/8th or 1/16th of the dataset. Additionally we learned that we could get cloud compute with 2-300 GB RAM at Azure.</p>
<p>Using this knowledge we applied the following optimization:</p>
<ol type="1">
<li>Load sliced data into RAM on-demand rather than reading by streaming it into memory</li>
</ol>
<p>Applying this change we saw huge efficiency gains but we still spent a lot of time in the <code>DataLoader</code>, why? We found that on each batch load we converted our data into a <code>torch.tensor</code> which should be pretty fast, but it still end up being a bottleneck. Next optimization became clear, why not keep it as a tensor from the get-go?</p>
<ol start="2" type="1">
<li>Load data into RAM as a dictionary&nbsp;<code>{"column": torch.tensor()}</code>&nbsp; with each column being key</li>
</ol>
<p><strong>Thus we achieved a really efficient (Deep Learning) pipeline, training being cut from hours to minutes! 🤯</strong></p>
</section>
</section>
<section id="what-we-learned" class="level1">
<h1>What we learned</h1>
<ul>
<li><strong>Best practices are contextual.</strong>
<ul>
<li>Custom&nbsp;<em>“dumb”</em>&nbsp;code&nbsp;could end up much more efficient.</li>
</ul></li>
<li>Start Simple.
<ul>
<li>Simpler is often better (apply KISS).</li>
</ul></li>
<li>Custom code is not always more complex than libraries because they hide complexity.</li>
<li>Balance complexity and efficiency delicately.</li>
</ul>
<p>By batching data smarter and keeping a lot of it as tensors in-memory we had an incredible amount of gains.</p>
<p>It’s simple, stupid and wonderful.</p>
<p>~Hampus Londögård</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="londogard/londogard" data-repo-id="MDEwOlJlcG9zaXRvcnkyOTcyNzE0MzE=" data-category="General" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMwODYxNzM4" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://www.buymeacoffee.com/hlondogard"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" class="img-fluid" width="100"></a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://github.com/sponsors/Lundez?o=esb"><img src="https://img.shields.io/static/v1?label=Sponsor&amp;message=%E2%9D%A4&amp;logo=GitHub&amp;color=%23fe8e86.png" class="img-fluid" width="100"></a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../pages/about.html">About</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hampus-londögård/">
      <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hlondogard">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lundez">
      <i class="bi bi-github" role="img" aria-label="Lundez GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../index.xml">
      <i class="bi bi-rss" role="img" aria-label="Londogard Blog RSS">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>